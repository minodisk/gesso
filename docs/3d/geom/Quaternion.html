<!DOCTYPE html> <html> <head>   <title>Quaternion.coffee</title>   <meta charset="UTF-8">   <link rel="stylesheet" media="all" href="../../../resources/rocco.css" /> </head> <body> <div id="navbar">     <h3>graphicsJS Documentation - The wrapper of API for drawing on the canvas.<em></em></h3>   </div>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">           <a class="source" href="index.html">Index</a>                                           <a class="source" href="Camera.html">                 Camera.coffee               </a>                                           <a class="source" href="Renderer.html">                 Renderer.coffee               </a>                                           <a class="source" href="Scene.html">                 Scene.coffee               </a>                                           <a class="source" href="Screen.html">                 Screen.coffee               </a>                                           <a class="source" href="DisplayObject.html">                 DisplayObject.coffee               </a>                                           <a class="source" href="Dot.html">                 Dot.coffee               </a>                                           <a class="source" href="Line.html">                 Line.coffee               </a>                                           <a class="source" href="Plane.html">                 Plane.coffee               </a>                                           <a class="source" href="Sphere.html">                 Sphere.coffee               </a>                                           <a class="source" href="AABB.html">                 AABB.coffee               </a>                                           <a class="source" href="EulerAngles.html">                 EulerAngles.coffee               </a>                                           <a class="source" href="Matrix.html">                 Matrix.coffee               </a>                                           <a class="source" href="Quaternion.html">                 Quaternion.coffee               </a>                                           <a class="source" href="RotationMatrix.html">                 RotationMatrix.coffee               </a>                                           <a class="source" href="Vector.html">                 Vector.coffee               </a>                                           <a class="source" href="Klass.html">                 Klass.coffee               </a>                                           <a class="source" href="Bitmap.html">                 Bitmap.coffee               </a>                                           <a class="source" href="Blend.html">                 Blend.coffee               </a>                                           <a class="source" href="BlendMode.html">                 BlendMode.coffee               </a>                                           <a class="source" href="CapsStyle.html">                 CapsStyle.coffee               </a>                                           <a class="source" href="DisplayObject.html">                 DisplayObject.coffee               </a>                                           <a class="source" href="GradientType.html">                 GradientType.coffee               </a>                                           <a class="source" href="Graphics.html">                 Graphics.coffee               </a>                                           <a class="source" href="InteractiveObject.html">                 InteractiveObject.coffee               </a>                                           <a class="source" href="JointStyle.html">                 JointStyle.coffee               </a>                                           <a class="source" href="Loader.html">                 Loader.coffee               </a>                                           <a class="source" href="Shape.html">                 Shape.coffee               </a>                                           <a class="source" href="Sprite.html">                 Sprite.coffee               </a>                                           <a class="source" href="Stage.html">                 Stage.coffee               </a>                                           <a class="source" href="Event.html">                 Event.coffee               </a>                                           <a class="source" href="EventDispatcher.html">                 EventDispatcher.coffee               </a>                                           <a class="source" href="EventPhase.html">                 EventPhase.coffee               </a>                                           <a class="source" href="KeyboardEvent.html">                 KeyboardEvent.coffee               </a>                                           <a class="source" href="MouseEvent.html">                 MouseEvent.coffee               </a>                                           <a class="source" href="BilateralFilter.html">                 BilateralFilter.coffee               </a>                                           <a class="source" href="BlurFilter.html">                 BlurFilter.coffee               </a>                                           <a class="source" href="ColorMatrixFilter.html">                 ColorMatrixFilter.coffee               </a>                                           <a class="source" href="DeficiencyType.html">                 DeficiencyType.coffee               </a>                                           <a class="source" href="DoubleFilter.html">                 DoubleFilter.coffee               </a>                                           <a class="source" href="Filter.html">                 Filter.coffee               </a>                                           <a class="source" href="GaussianFilter.html">                 GaussianFilter.coffee               </a>                                           <a class="source" href="KernelFilter.html">                 KernelFilter.coffee               </a>                                           <a class="source" href="LaplacianFilter.html">                 LaplacianFilter.coffee               </a>                                           <a class="source" href="MedianFilter.html">                 MedianFilter.coffee               </a>                                           <a class="source" href="PrewittFilter.html">                 PrewittFilter.coffee               </a>                                           <a class="source" href="SobelFilter.html">                 SobelFilter.coffee               </a>                                           <a class="source" href="UnsharpMaskFilter.html">                 UnsharpMaskFilter.coffee               </a>                                           <a class="source" href="ColorMatrix.html">                 ColorMatrix.coffee               </a>                                           <a class="source" href="Matrix.html">                 Matrix.coffee               </a>                                           <a class="source" href="Quadtree.html">                 Quadtree.coffee               </a>                                           <a class="source" href="QuadtreeSpace.html">                 QuadtreeSpace.coffee               </a>                                           <a class="source" href="Rectangle.html">                 Rectangle.coffee               </a>                                           <a class="source" href="Vector.html">                 Vector.coffee               </a>                                           <a class="source" href="DateFormat.html">                 DateFormat.coffee               </a>                                           <a class="source" href="JSON.html">                 JSON.coffee               </a>                                           <a class="source" href="QueryString.html">                 QueryString.coffee               </a>                                           <a class="source" href="Capabilities.html">                 Capabilities.coffee               </a>                                           <a class="source" href="TextField.html">                 TextField.coffee               </a>                                           <a class="source" href="TextFormat.html">                 TextFormat.coffee               </a>                                           <a class="source" href="TextFormatAlign.html">                 TextFormatAlign.coffee               </a>                                           <a class="source" href="TextFormatBaseline.html">                 TextFormatBaseline.coffee               </a>                                           <a class="source" href="TextFormatFont.html">                 TextFormatFont.coffee               </a>                                           <a class="source" href="Stopwatch.html">                 Stopwatch.coffee               </a>                                           <a class="source" href="Ticker.html">                 Ticker.coffee               </a>                                           <a class="source" href="Timer.html">                 Timer.coffee               </a>                                           <a class="source" href="Easing.html">                 Easing.coffee               </a>                                           <a class="source" href="Tween.html">                 Tween.coffee               </a>                                           <a class="source" href="ArrayUtil.html">                 ArrayUtil.coffee               </a>                                           <a class="source" href="MathUtil.html">                 MathUtil.coffee               </a>                                           <a class="source" href="ObjectUtil.html">                 ObjectUtil.coffee               </a>                                           <a class="source" href="StringUtil.html">                 StringUtil.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               Quaternion.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p><strong>Experimental Implementation</strong></p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Implement a quaternion, for purposes of representing an angular
displacement (orientation) in 3D.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Vector = </span><span class="nx">require</span> <span class="s1">&#39;3d/geom/Vector&#39;</span>
<span class="nv">MathUtil = </span><span class="nx">require</span> <span class="s1">&#39;utils/MathUtil&#39;</span>

<span class="nv">abs = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span>
<span class="nv">sqrt = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span>
<span class="nv">sin = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span>
<span class="nv">cos = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">cos</span>
<span class="nv">safeAcos = </span><span class="nx">MathUtil</span><span class="p">.</span><span class="nx">safeAcos</span>

<span class="nv">module.exports = </span><span class="k">class</span> <span class="nx">Quaternion</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>The global identity quaternion.  Notice that there are no constructors
to the Quaternion class, since we really don't need any.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@IDENTITY: </span><span class="k">new</span> <span class="nx">Quaternion</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>dotProduct</p>

<p>Quaternion dot product.  We use a nonmember function so we can
pass quaternion expressions as operands without having "funky syntax"</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">@dotProduct</span><span class="o">:</span><span class="nf">(a, b)-&gt;</span>
    <span class="nx">a</span><span class="p">.</span><span class="nx">w</span> <span class="o">*</span> <span class="nx">b</span><span class="p">.</span><span class="nx">w</span> <span class="o">+</span> <span class="nx">a</span><span class="p">.</span><span class="nx">x</span> <span class="o">*</span> <span class="nx">b</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="nx">a</span><span class="p">.</span><span class="nx">y</span> <span class="o">*</span> <span class="nx">b</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="nx">a</span><span class="p">.</span><span class="nx">z</span> <span class="o">*</span> <span class="nx">b</span><span class="p">.</span><span class="nx">z</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>slerp</p>

<p>Spherical linear interpolation.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">@slerp</span><span class="o">:</span><span class="nf">(q0, q1, t)-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Check for out-of range parameter and return edge points if so</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">t</span> <span class="o">&lt;=</span> <span class="mi">0</span>
      <span class="nx">q0</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">t</span> <span class="o">&gt;=</span> <span class="mi">1</span>
      <span class="nx">q1</span>
    <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Compute "cosine of angle between quaternions" using dot product</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">cosOmega = </span><span class="nx">@dotProduct</span> <span class="nx">q0</span><span class="p">,</span> <span class="nx">q1</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>If negative dot, use -q1.  Two quaternions q and -q
represent the same rotation, but may produce
different slerp.  We chose q or -q to rotate using
the acute angle.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">q1w = </span><span class="nx">s1</span><span class="p">.</span><span class="nx">w</span>
      <span class="nv">q1x = </span><span class="nx">s1</span><span class="p">.</span><span class="nx">x</span>
      <span class="nv">q1y = </span><span class="nx">s1</span><span class="p">.</span><span class="nx">y</span>
      <span class="nv">q1z = </span><span class="nx">s1</span><span class="p">.</span><span class="nx">z</span>
      <span class="k">if</span> <span class="nx">cosOmega</span> <span class="o">&lt;</span> <span class="mi">0</span>
        <span class="nx">q1w</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="nx">q1x</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="nx">q1y</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="nx">q1z</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="nx">cosOmega</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>We should have two unit quaternions, so dot should be &lt;= 1.0</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">unless</span> <span class="nx">cosOmega</span> <span class="o">&lt;</span> <span class="mf">1.1</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s2">&quot;&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Compute interpolation fraction, checking for quaternions
almost exactly the same</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">cosOmega</span> <span class="o">&gt;</span> <span class="mf">0.9999</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Very close - just use linear interpolation,
which will protect againt a divide by zero</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">k0 = </span><span class="mi">1</span> <span class="o">-</span> <span class="nx">t</span>
        <span class="nv">k1 = </span><span class="nx">t</span>
      <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Compute the sin of the angle using the
trig identity sin^2(omega) + cos^2(omega) = 1</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">sinOmega = </span><span class="nx">sqrt</span> <span class="mi">1</span> <span class="o">-</span> <span class="nx">cosOmega</span> <span class="o">*</span> <span class="nx">cosOmega</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Compute the angle from its sin and cosine</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">omega = </span><span class="nx">atan2</span> <span class="nx">sinOmega</span><span class="p">,</span> <span class="nx">cosOmega</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Compute inverse of denominator, so we only have
to divide once</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">oneOverSinOmega = </span><span class="mi">1</span> <span class="o">/</span> <span class="nx">sinOmega</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Compute interpolation parameters</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">k0 = </span><span class="nx">sin</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="nx">t</span><span class="p">)</span> <span class="o">*</span> <span class="nx">omega</span><span class="p">)</span> <span class="o">*</span> <span class="nx">oneOverSinOmega</span>
        <span class="nv">k1 = </span><span class="nx">sin</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span> <span class="nx">omega</span><span class="p">)</span> <span class="o">*</span> <span class="nx">oneOverSinOmega</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Interpolate</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">new</span> <span class="nx">Quaternion</span><span class="p">(</span>
        <span class="nx">k0</span> <span class="o">*</span> <span class="nx">q0</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">k1</span> <span class="o">*</span> <span class="nx">q1x</span>
        <span class="nx">k0</span> <span class="o">*</span> <span class="nx">q0</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="nx">k1</span> <span class="o">*</span> <span class="nx">q1y</span>
        <span class="nx">k0</span> <span class="o">*</span> <span class="nx">q0</span><span class="p">.</span><span class="nx">z</span> <span class="o">+</span> <span class="nx">k1</span> <span class="o">*</span> <span class="nx">q1z</span>
        <span class="nx">k0</span> <span class="o">*</span> <span class="nx">q0</span><span class="p">.</span><span class="nx">w</span> <span class="o">+</span> <span class="nx">k1</span> <span class="o">*</span> <span class="nx">q1w</span>
      <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>conjugate</p>

<p>Compute the quaternion conjugate.  This is the quaternian
with the opposite rotation as the original quaternian.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">@conjugate</span><span class="o">:</span><span class="nf">(q)-&gt;</span>
    <span class="k">new</span> <span class="nx">Quaternion</span><span class="p">(</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Same rotation amount</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">q</span><span class="p">.</span><span class="nx">w</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Opposite axis of rotation</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="o">-</span><span class="nx">q</span><span class="p">.</span><span class="nx">x</span>
      <span class="o">-</span><span class="nx">q</span><span class="p">.</span><span class="nx">y</span>
      <span class="o">-</span><span class="nx">q</span><span class="p">.</span><span class="nx">z</span>
    <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>pow</p>

<p>Quaternion exponentiation.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">@pow</span><span class="o">:</span><span class="nf">(q, exponent)-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Check for the case of an identity quaternion.
This will protect against divide by zero</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">abs</span><span class="p">(</span><span class="nx">q</span><span class="p">.</span><span class="nx">w</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.9999</span>
      <span class="nx">q</span>
    <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Extract the half angle alpha (alpha = theta/2)</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">alpha = </span><span class="nx">acos</span> <span class="nx">q</span><span class="p">.</span><span class="nx">w</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Compute new alpha value</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">newAlpha = </span><span class="nx">alpha</span> <span class="o">*</span> <span class="nx">exponent</span>
      <span class="nv">mult = </span><span class="nx">sin</span><span class="p">(</span><span class="nx">newAlpha</span><span class="p">)</span> <span class="o">/</span> <span class="nx">sin</span><span class="p">(</span><span class="nx">alpha</span><span class="p">)</span>
      <span class="k">new</span> <span class="nx">Quaternion</span><span class="p">(</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Compute new w value</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">cos</span> <span class="nx">newAlpha</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Compute new xyz values</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">q</span><span class="p">.</span><span class="nx">x</span> <span class="o">*</span> <span class="nx">mult</span>
        <span class="nx">q</span><span class="p">.</span><span class="nx">y</span> <span class="o">*</span> <span class="nx">mult</span>
        <span class="nx">q</span><span class="p">.</span><span class="nx">z</span> <span class="o">*</span> <span class="nx">mult</span>
      <span class="p">)</span>

  <span class="nx">constructor</span><span class="o">:</span><span class="nf">(w, x, y, z)-&gt;</span>
    <span class="nx">unless</span> <span class="err">@</span> <span class="k">instanceof</span> <span class="nx">Quaternion</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nx">Quaternion</span> <span class="nx">w</span><span class="p">,</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">z</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">q = </span><span class="nx">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">instanceof</span> <span class="nx">Quaternion</span>
      <span class="vi">@w = </span><span class="nx">q</span><span class="p">.</span><span class="nx">w</span>
      <span class="vi">@x = </span><span class="nx">q</span><span class="p">.</span><span class="nx">x</span>
      <span class="vi">@y = </span><span class="nx">q</span><span class="p">.</span><span class="nx">y</span>
      <span class="vi">@z = </span><span class="nx">q</span><span class="p">.</span><span class="nx">z</span>
    <span class="k">else</span>
      <span class="vi">@w = </span><span class="nx">w</span>
      <span class="vi">@x = </span><span class="nx">x</span>
      <span class="vi">@y = </span><span class="nx">y</span>
      <span class="vi">@z = </span><span class="nx">z</span>

  <span class="nx">identity</span><span class="o">:-&gt;</span>
    <span class="vi">@w = </span><span class="mi">1</span>
    <span class="vi">@x = @y = @z = </span><span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>Quaternion::setToRotateAboutX
Quaternion::setToRotateAboutY
Quaternion::setToRotateAboutZ
Quaternion::setToRotateAboutAxis</p>

<p>Setup the quaternion to rotate about the specified axis</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">setToRotateAboutX</span><span class="o">:</span><span class="nf">(theta)-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Compute the half angle</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">theta_2 = </span><span class="nx">theta</span> <span class="err">/ 2</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Set the values</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@w = </span><span class="nx">cos</span> <span class="nx">theta_2</span>
    <span class="vi">@x = </span><span class="nx">sin</span> <span class="nx">theta_2</span>
    <span class="vi">@y = </span><span class="mi">0</span>
    <span class="vi">@z = </span><span class="mi">0</span>

  <span class="nx">setToRotateAboutY</span><span class="o">:</span><span class="nf">(theta)-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>Compute the half angle</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">theta_2 = </span><span class="nx">theta</span> <span class="err">/ 2</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>Set the values</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@w = </span><span class="nx">cos</span> <span class="nx">theta_2</span>
    <span class="vi">@x = </span><span class="mi">0</span>
    <span class="vi">@y = </span><span class="nx">sin</span> <span class="nx">theta_2</span>
    <span class="vi">@z = </span><span class="mi">0</span>

  <span class="nx">setToRotateAboutZ</span><span class="o">:</span><span class="nf">(theta)-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Compute the half angle</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">theta_2 = </span><span class="nx">theta</span> <span class="err">/ 2</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>Set the values</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@w = </span><span class="nx">cos</span> <span class="nx">theta_2</span>
    <span class="vi">@x = </span><span class="mi">0</span>
    <span class="vi">@y = </span><span class="nx">sin</span> <span class="nx">theta_2</span>
    <span class="vi">@z = </span><span class="mi">0</span>

  <span class="nx">setToRotateAboutAxis</span><span class="o">:</span><span class="nf">(axis, theta)-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>The axis of rotation must be normalized</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">unless</span> <span class="nx">abs</span><span class="p">(</span><span class="nx">Vector</span><span class="p">.</span><span class="nx">magnitude</span><span class="p">(</span><span class="nx">axis</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.01</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s2">&quot;&#39;axis&#39; should be normalized.&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>Compute the half angle and its sin</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">thetaOver2 = </span><span class="nx">theta</span> <span class="err">/ 2</span>
    <span class="nv">sinThetaOver2 = </span><span class="nx">sin</span> <span class="nx">thetaOver2</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>Set the values</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@w = </span><span class="nx">con</span> <span class="nx">thetaOver2</span>
    <span class="vi">@x = </span><span class="nx">axis</span><span class="p">.</span><span class="nx">x</span> <span class="o">*</span> <span class="nx">sinThetaOver2</span>
    <span class="vi">@y = </span><span class="nx">axis</span><span class="p">.</span><span class="nx">y</span> <span class="o">*</span> <span class="nx">sinThetaOver2</span>
    <span class="vi">@z = </span><span class="nx">axis</span><span class="p">.</span><span class="nx">z</span> <span class="o">*</span> <span class="nx">sinThetaOver2</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>EulerAngles::setToRotateObjectToInertial</p>

<p>Setup the quaternion to perform an object->inertial rotation, given the
orientation in Euler angle format</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">setToRotateObjectToInertial</span><span class="o">:</span><span class="nf">(orientation)-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>Compute sine and cosine of the half angles</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">headingOver2 = </span><span class="nx">orientation</span><span class="p">.</span><span class="nx">heading</span> <span class="err">/ 2</span>
    <span class="nv">pitchOver2 = </span><span class="nx">orientation</span><span class="p">.</span><span class="nx">pitch</span> <span class="err">/ 2</span>
    <span class="nv">bankOver2 = </span><span class="nx">orientation</span><span class="p">.</span><span class="nx">bank</span> <span class="err">/ 2</span>
    <span class="nv">sh = </span><span class="nx">sin</span> <span class="nx">headingOver2</span>
    <span class="nv">ch = </span><span class="nx">cos</span> <span class="nx">headingOver2</span>
    <span class="nv">sp = </span><span class="nx">sin</span> <span class="nx">pitchOver2</span>
    <span class="nv">cp = </span><span class="nx">cos</span> <span class="nx">pitchOver2</span>
    <span class="nv">sb = </span><span class="nx">sin</span> <span class="nx">bankOver2</span>
    <span class="nv">cb = </span><span class="nx">cos</span> <span class="nx">bankOver2</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>Compute values</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@w = </span><span class="nx">ch</span> <span class="o">*</span> <span class="nx">cp</span> <span class="o">*</span> <span class="nx">cb</span> <span class="o">+</span> <span class="nx">sh</span> <span class="o">*</span> <span class="nx">sp</span> <span class="o">*</span> <span class="nx">sb</span>
    <span class="vi">@x = </span><span class="nx">ch</span> <span class="o">*</span> <span class="nx">sp</span> <span class="o">*</span> <span class="nx">cb</span> <span class="o">+</span> <span class="nx">sh</span> <span class="o">*</span> <span class="nx">cp</span> <span class="o">*</span> <span class="nx">sb</span>
    <span class="vi">@y = </span><span class="o">-</span><span class="nx">ch</span> <span class="o">*</span> <span class="nx">sp</span> <span class="o">*</span> <span class="nx">sb</span> <span class="o">+</span> <span class="nx">sh</span> <span class="o">*</span> <span class="nx">cp</span> <span class="o">*</span> <span class="nx">cb</span>
    <span class="vi">@z = </span><span class="o">-</span><span class="nx">sh</span> <span class="o">*</span> <span class="nx">sp</span> <span class="o">*</span> <span class="nx">cb</span> <span class="o">+</span> <span class="nx">ch</span> <span class="o">*</span> <span class="nx">cp</span> <span class="o">*</span> <span class="nx">sb</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>EulerAngles::setToRotateInertialToObject</p>

<p>Setup the quaternion to perform an object->inertial rotation, given the
orientation in Euler angle format</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">setToRotateInertialToObject</span><span class="o">:</span><span class="nf">(orientation)-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>Compute sine and cosine of the half angles</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">headingOver2 = </span><span class="nx">orientation</span><span class="p">.</span><span class="nx">heading</span> <span class="err">/ 2</span>
    <span class="nv">pitchOver2 = </span><span class="nx">orientation</span><span class="p">.</span><span class="nx">pitch</span> <span class="err">/ 2</span>
    <span class="nv">bankOver2 = </span><span class="nx">orientation</span><span class="p">.</span><span class="nx">bank</span> <span class="err">/ 2</span>
    <span class="nv">sh = </span><span class="nx">sin</span> <span class="nx">headingOver2</span>
    <span class="nv">ch = </span><span class="nx">cos</span> <span class="nx">headingOver2</span>
    <span class="nv">sp = </span><span class="nx">sin</span> <span class="nx">pitchOver2</span>
    <span class="nv">cp = </span><span class="nx">cos</span> <span class="nx">pitchOver2</span>
    <span class="nv">sb = </span><span class="nx">sin</span> <span class="nx">bankOver2</span>
    <span class="nv">cb = </span><span class="nx">cos</span> <span class="nx">bankOver2</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>Compute values</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@w = </span><span class="nx">ch</span> <span class="o">*</span> <span class="nx">cp</span> <span class="o">*</span> <span class="nx">cb</span> <span class="o">+</span> <span class="nx">sh</span> <span class="o">*</span> <span class="nx">sp</span> <span class="o">*</span> <span class="nx">sb</span>
    <span class="vi">@x = </span><span class="o">-</span><span class="nx">ch</span> <span class="o">*</span> <span class="nx">sp</span> <span class="o">*</span> <span class="nx">cb</span> <span class="o">-</span> <span class="nx">sh</span> <span class="o">*</span> <span class="nx">cp</span> <span class="o">*</span> <span class="nx">sb</span>
    <span class="vi">@y = </span><span class="nx">ch</span> <span class="o">*</span> <span class="nx">sp</span> <span class="o">*</span> <span class="nx">sb</span> <span class="o">-</span> <span class="nx">sh</span> <span class="o">*</span> <span class="nx">cp</span> <span class="o">*</span> <span class="nx">cb</span>
    <span class="vi">@z = </span><span class="nx">sh</span> <span class="o">*</span> <span class="nx">sp</span> <span class="o">*</span> <span class="nx">cb</span> <span class="o">-</span> <span class="nx">ch</span> <span class="o">*</span> <span class="nx">cp</span> <span class="o">*</span> <span class="nx">sb</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>Quaternion cross product, which concatonates multiple angular
displacements.  The order of multiplication, from left to right,
corresponds to the order that the angular displacements are
applied.  This is backwards from the <em>standard</em> definition of
quaternion multiplication.  See section 10.4.8 for the rationale
behind this deviation from the standard.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">crossProduct</span><span class="o">:</span><span class="nf">(q)-&gt;</span>
    <span class="k">new</span> <span class="nx">Quaternion</span><span class="p">(</span>
      <span class="nx">@w</span> <span class="o">*</span> <span class="nx">q</span><span class="p">.</span><span class="nx">w</span> <span class="o">-</span> <span class="nx">@x</span> <span class="o">*</span> <span class="nx">q</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">@y</span> <span class="o">*</span> <span class="nx">q</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="nx">@z</span> <span class="o">*</span> <span class="nx">q</span><span class="p">.</span><span class="nx">z</span>
      <span class="nx">@w</span> <span class="o">*</span> <span class="nx">q</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">@x</span> <span class="o">*</span> <span class="nx">q</span><span class="p">.</span><span class="nx">w</span> <span class="o">+</span> <span class="nx">@z</span> <span class="o">*</span> <span class="nx">q</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="nx">@y</span> <span class="o">*</span> <span class="nx">q</span><span class="p">.</span><span class="nx">z</span>
      <span class="nx">@w</span> <span class="o">*</span> <span class="nx">q</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="nx">@y</span> <span class="o">*</span> <span class="nx">q</span><span class="p">.</span><span class="nx">w</span> <span class="o">+</span> <span class="nx">@x</span> <span class="o">*</span> <span class="nx">q</span><span class="p">.</span><span class="nx">z</span> <span class="o">-</span> <span class="nx">@z</span> <span class="o">*</span> <span class="nx">q</span><span class="p">.</span><span class="nx">x</span>
      <span class="nx">@w</span> <span class="o">*</span> <span class="nx">q</span><span class="p">.</span><span class="nx">z</span> <span class="o">+</span> <span class="nx">@z</span> <span class="o">*</span> <span class="nx">q</span><span class="p">.</span><span class="nx">w</span> <span class="o">+</span> <span class="nx">@y</span> <span class="o">*</span> <span class="nx">q</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">@x</span> <span class="o">*</span> <span class="nx">q</span><span class="p">.</span><span class="nx">y</span>
    <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>Quaternion::normalize</p>

<p>"Normalize" a quaternion.  Note that normally, quaternions
are always normalized (within limits of numerical precision).
See section 10.4.6 for more information.</p>

<p>This function is provided primarily to combat floating point "error
creep," which can occur when many successive quaternion operations
are applied.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">normalize</span><span class="o">:-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>Compute magnitude of the quaternion</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">mag = </span><span class="nx">sqrt</span> <span class="nx">@w</span> <span class="o">*</span> <span class="nx">@w</span> <span class="o">+</span> <span class="nx">@x</span> <span class="o">*</span> <span class="nx">@x</span> <span class="o">+</span> <span class="nx">@y</span> <span class="o">*</span> <span class="nx">@y</span> <span class="o">+</span> <span class="nx">@z</span> <span class="o">*</span> <span class="nx">@z</span>
    <span class="k">if</span> <span class="nx">mag</span> <span class="o">&gt;</span> <span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>Normalize it</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">oneOverMag = </span><span class="mi">1</span> <span class="o">/</span> <span class="nx">mag</span>
      <span class="nx">@w</span> <span class="o">+=</span> <span class="nx">oneOverMag</span>
      <span class="nx">@x</span> <span class="o">+=</span> <span class="nx">oneOverMag</span>
      <span class="nx">@y</span> <span class="o">+=</span> <span class="nx">oneOverMag</span>
      <span class="nx">@z</span> <span class="o">+=</span> <span class="nx">oneOverMag</span>
    <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>Houston, we have a problem</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s2">&quot;Zero magnitude&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>In a release build, just slam it to something</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@identity</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>Quaternion::getRotationAngle</p>

<p>Return the rotation angle theta</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">getRotationAngle</span><span class="o">:-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>Compute the half angle.  Remember that w = cos(theta / 2)</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">thetaOver2 = </span><span class="nx">safeAcos</span> <span class="nx">@w</span></pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p>Return the rotation angle</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">thetaOver2</span> <span class="o">*</span> <span class="mi">2</span></pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <p>Quaternion::getRotationAxis</p>

<p>Return the rotation axis</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">getRotationAxis</span><span class="o">:-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p>Compute sin^2(theta/2).  Remember that w = cos(theta/2),
and sin^2(x) + cos^2(x) = 1</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">sinThetaOver2Sq = </span><span class="mi">1</span> <span class="o">-</span> <span class="nx">@w</span> <span class="o">*</span> <span class="nx">@w</span></pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <p>Protect against numerical imprecision</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">sinThetaOver2Sq</span> <span class="o">&lt;=</span> <span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <p>Identity quaternion, or numerical imprecision.  Just
return any valid vector, since it doesn't matter</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">new</span> <span class="nx">Vector</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
    <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p>Compute 1 / sin(theta/2)</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">oneOverSinThetaOver2 = </span><span class="mi">1</span> <span class="o">/</span> <span class="nx">sqrt</span> <span class="nx">sinThetaOver2Sq</span></pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <p>Return axis of rotation</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">new</span> <span class="nx">Vector</span><span class="p">(</span>
        <span class="nx">@x</span> <span class="o">*</span> <span class="nx">oneOverSinThetaOver2</span>
        <span class="nx">@y</span> <span class="o">*</span> <span class="nx">oneOverSinThetaOver2</span>
        <span class="nx">@z</span> <span class="o">*</span> <span class="nx">oneOverSinThetaOver2</span>
      <span class="p">)</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 