<!DOCTYPE html> <html> <head>   <title>Matrix.coffee</title>   <meta charset="UTF-8">   <link rel="stylesheet" media="all" href="../../../resources/rocco.css" /> </head> <body> <div id="navbar">     <h3>graphicsJS Documentation - The wrapper of API for drawing on the canvas.<em></em></h3>   </div>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">           <a class="source" href="index.html">Index</a>                                           <a class="source" href="Camera.html">                 Camera.coffee               </a>                                           <a class="source" href="Renderer.html">                 Renderer.coffee               </a>                                           <a class="source" href="Scene.html">                 Scene.coffee               </a>                                           <a class="source" href="Screen.html">                 Screen.coffee               </a>                                           <a class="source" href="DisplayObject.html">                 DisplayObject.coffee               </a>                                           <a class="source" href="Dot.html">                 Dot.coffee               </a>                                           <a class="source" href="Line.html">                 Line.coffee               </a>                                           <a class="source" href="Plane.html">                 Plane.coffee               </a>                                           <a class="source" href="Sphere.html">                 Sphere.coffee               </a>                                           <a class="source" href="AABB.html">                 AABB.coffee               </a>                                           <a class="source" href="EulerAngles.html">                 EulerAngles.coffee               </a>                                           <a class="source" href="Matrix.html">                 Matrix.coffee               </a>                                           <a class="source" href="Quaternion.html">                 Quaternion.coffee               </a>                                           <a class="source" href="RotationMatrix.html">                 RotationMatrix.coffee               </a>                                           <a class="source" href="Vector.html">                 Vector.coffee               </a>                                           <a class="source" href="Klass.html">                 Klass.coffee               </a>                                           <a class="source" href="Bitmap.html">                 Bitmap.coffee               </a>                                           <a class="source" href="Blend.html">                 Blend.coffee               </a>                                           <a class="source" href="BlendMode.html">                 BlendMode.coffee               </a>                                           <a class="source" href="CapsStyle.html">                 CapsStyle.coffee               </a>                                           <a class="source" href="DisplayObject.html">                 DisplayObject.coffee               </a>                                           <a class="source" href="GradientType.html">                 GradientType.coffee               </a>                                           <a class="source" href="Graphics.html">                 Graphics.coffee               </a>                                           <a class="source" href="InteractiveObject.html">                 InteractiveObject.coffee               </a>                                           <a class="source" href="JointStyle.html">                 JointStyle.coffee               </a>                                           <a class="source" href="Loader.html">                 Loader.coffee               </a>                                           <a class="source" href="Shape.html">                 Shape.coffee               </a>                                           <a class="source" href="Sprite.html">                 Sprite.coffee               </a>                                           <a class="source" href="Stage.html">                 Stage.coffee               </a>                                           <a class="source" href="Event.html">                 Event.coffee               </a>                                           <a class="source" href="EventDispatcher.html">                 EventDispatcher.coffee               </a>                                           <a class="source" href="EventPhase.html">                 EventPhase.coffee               </a>                                           <a class="source" href="KeyboardEvent.html">                 KeyboardEvent.coffee               </a>                                           <a class="source" href="MouseEvent.html">                 MouseEvent.coffee               </a>                                           <a class="source" href="BilateralFilter.html">                 BilateralFilter.coffee               </a>                                           <a class="source" href="BlurFilter.html">                 BlurFilter.coffee               </a>                                           <a class="source" href="ColorMatrixFilter.html">                 ColorMatrixFilter.coffee               </a>                                           <a class="source" href="DeficiencyType.html">                 DeficiencyType.coffee               </a>                                           <a class="source" href="DoubleFilter.html">                 DoubleFilter.coffee               </a>                                           <a class="source" href="Filter.html">                 Filter.coffee               </a>                                           <a class="source" href="GaussianFilter.html">                 GaussianFilter.coffee               </a>                                           <a class="source" href="KernelFilter.html">                 KernelFilter.coffee               </a>                                           <a class="source" href="LaplacianFilter.html">                 LaplacianFilter.coffee               </a>                                           <a class="source" href="MedianFilter.html">                 MedianFilter.coffee               </a>                                           <a class="source" href="PrewittFilter.html">                 PrewittFilter.coffee               </a>                                           <a class="source" href="SobelFilter.html">                 SobelFilter.coffee               </a>                                           <a class="source" href="UnsharpMaskFilter.html">                 UnsharpMaskFilter.coffee               </a>                                           <a class="source" href="ColorMatrix.html">                 ColorMatrix.coffee               </a>                                           <a class="source" href="Matrix.html">                 Matrix.coffee               </a>                                           <a class="source" href="Quadtree.html">                 Quadtree.coffee               </a>                                           <a class="source" href="QuadtreeSpace.html">                 QuadtreeSpace.coffee               </a>                                           <a class="source" href="Rectangle.html">                 Rectangle.coffee               </a>                                           <a class="source" href="Vector.html">                 Vector.coffee               </a>                                           <a class="source" href="DateFormat.html">                 DateFormat.coffee               </a>                                           <a class="source" href="JSON.html">                 JSON.coffee               </a>                                           <a class="source" href="QueryString.html">                 QueryString.coffee               </a>                                           <a class="source" href="Capabilities.html">                 Capabilities.coffee               </a>                                           <a class="source" href="TextField.html">                 TextField.coffee               </a>                                           <a class="source" href="TextFormat.html">                 TextFormat.coffee               </a>                                           <a class="source" href="TextFormatAlign.html">                 TextFormatAlign.coffee               </a>                                           <a class="source" href="TextFormatBaseline.html">                 TextFormatBaseline.coffee               </a>                                           <a class="source" href="TextFormatFont.html">                 TextFormatFont.coffee               </a>                                           <a class="source" href="Stopwatch.html">                 Stopwatch.coffee               </a>                                           <a class="source" href="Ticker.html">                 Ticker.coffee               </a>                                           <a class="source" href="Timer.html">                 Timer.coffee               </a>                                           <a class="source" href="Easing.html">                 Easing.coffee               </a>                                           <a class="source" href="Tween.html">                 Tween.coffee               </a>                                           <a class="source" href="ArrayUtil.html">                 ArrayUtil.coffee               </a>                                           <a class="source" href="MathUtil.html">                 MathUtil.coffee               </a>                                           <a class="source" href="ObjectUtil.html">                 ObjectUtil.coffee               </a>                                           <a class="source" href="StringUtil.html">                 StringUtil.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               Matrix.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p><strong>Experimental Implementation</strong></p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Implement a 4x3 transformation matrix.  This class can represent
any 3D affine transformation.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>class Matrix</p>

<p>Implement a 4x3 transformation matrix.  This class can represent
any 3D affine transformation.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>MATRIX ORGANIZATION</p>

<p>The purpose of this class is so that a user might perform transformations
without fiddling with plus or minus signs or transposing the matrix
until the output "looks right."  But of course, the specifics of the
internal representation is important.  Not only for the implementation
in this file to be correct, but occasionally direct access to the
matrix variables is necessary, or beneficial for optimization.  Thus,
we document our matrix conventions here.</p>

<p>We use row vectors, so multiplying by our matrix looks like this:</p>

<pre><code>          | m11 m12 m13 |
[ x y z ] | m21 m22 m23 | = [ x' y' z' ]
          | m31 m32 m33 |
          | tx  ty  tz  |</code></pre>

<p>Strict adherance to linear algebra rules dictates that this
multiplication is actually undefined.  To circumvent this, we can
consider the input and output vectors as having an assumed fourth
coordinate of 1.  Also, since we cannot technically invert a 4x3 matrix
according to linear algebra rules, we will also assume a rightmost
column of [ 0 0 0 1 ].  This is shown below:</p>

<pre><code>            | m11 m12 m13 0 |
[ x y z 1 ] | m21 m22 m23 0 | = [ x' y' z' 1 ]
            | m31 m32 m33 0 |
            | tx  ty  tz  1 |</code></pre>

<p>In case you have forgotten your linear algebra rules for multiplying
matrices (which are described in section 7.1.6 and 7.1.7), see the
definition of operator* for the expanded computations.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">EulerAngles = </span><span class="nx">require</span> <span class="s1">&#39;3d/geom/EulerAngles&#39;</span>
<span class="nv">RotationMatrix = </span><span class="nx">require</span> <span class="s1">&#39;3d/geom/RotationMatrix&#39;</span>
<span class="nv">Quaternion = </span><span class="nx">require</span> <span class="s1">&#39;3d/geom/Quaternion&#39;</span>
<span class="nv">Vector = </span><span class="nx">require</span> <span class="s1">&#39;3d/geom/Vector&#39;</span>

<span class="nv">abs = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span>
<span class="nv">sin = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span>
<span class="nv">cos = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">cos</span>
<span class="nv">tan = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">tan</span>

<span class="nv">module.exports = </span><span class="k">class</span> <span class="nx">Matrix</span>

  <span class="vi">@IDENTITY = </span><span class="k">new</span> <span class="nx">Matrix</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <h2>multiply(a:<em>Vector</em>, b:<em>Matrix</em>):<em>Vector</em></h2>

<p>[static]
Transform the point.</p>

<h2>multiply(a:<em>Matrix</em>, <em>Matrix</em>):<em>Matrix</em></h2>

<p>[static]
Matrix concatenation.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">@multiply</span><span class="o">:</span><span class="nf">(a, b)-&gt;</span>
    <span class="nx">unless</span> <span class="nx">b</span> <span class="k">instanceof</span> <span class="nx">Matrix</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span> <span class="s2">&quot;&#39;b&#39; must be specified an instance of Matrix.&quot;</span>

    <span class="k">if</span> <span class="nx">a</span> <span class="k">instanceof</span> <span class="nx">Vector</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Grind through the linear algebra.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">new</span> <span class="nx">Vector</span><span class="p">(</span>
        <span class="nx">a</span><span class="p">.</span><span class="nx">x</span> <span class="o">*</span> <span class="nx">b</span><span class="p">.</span><span class="nx">m11</span> <span class="o">+</span> <span class="nx">a</span><span class="p">.</span><span class="nx">y</span> <span class="o">*</span> <span class="nx">b</span><span class="p">.</span><span class="nx">m21</span> <span class="o">+</span> <span class="nx">a</span><span class="p">.</span><span class="nx">z</span> <span class="o">*</span> <span class="nx">b</span><span class="p">.</span><span class="nx">m31</span> <span class="o">+</span> <span class="nx">b</span><span class="p">.</span><span class="nx">tx</span>
        <span class="nx">a</span><span class="p">.</span><span class="nx">x</span> <span class="o">*</span> <span class="nx">b</span><span class="p">.</span><span class="nx">m12</span> <span class="o">+</span> <span class="nx">a</span><span class="p">.</span><span class="nx">y</span> <span class="o">*</span> <span class="nx">b</span><span class="p">.</span><span class="nx">m22</span> <span class="o">+</span> <span class="nx">a</span><span class="p">.</span><span class="nx">z</span> <span class="o">*</span> <span class="nx">b</span><span class="p">.</span><span class="nx">m32</span> <span class="o">+</span> <span class="nx">b</span><span class="p">.</span><span class="nx">ty</span>
        <span class="nx">a</span><span class="p">.</span><span class="nx">x</span> <span class="o">*</span> <span class="nx">b</span><span class="p">.</span><span class="nx">m13</span> <span class="o">+</span> <span class="nx">a</span><span class="p">.</span><span class="nx">y</span> <span class="o">*</span> <span class="nx">b</span><span class="p">.</span><span class="nx">m23</span> <span class="o">+</span> <span class="nx">a</span><span class="p">.</span><span class="nx">z</span> <span class="o">*</span> <span class="nx">b</span><span class="p">.</span><span class="nx">m33</span> <span class="o">+</span> <span class="nx">b</span><span class="p">.</span><span class="nx">tz</span>
        <span class="p">)</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">a</span> <span class="k">instanceof</span> <span class="nx">Matrix</span>
      <span class="k">new</span> <span class="nx">Matrix</span><span class="p">(</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Compute the upper 3x3 (linear transformation) portion</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">a</span><span class="p">.</span><span class="nx">m11</span> <span class="o">*</span> <span class="nx">b</span><span class="p">.</span><span class="nx">m11</span> <span class="o">+</span> <span class="nx">a</span><span class="p">.</span><span class="nx">m12</span> <span class="o">*</span> <span class="nx">b</span><span class="p">.</span><span class="nx">m21</span> <span class="o">+</span> <span class="nx">a</span><span class="p">.</span><span class="nx">m13</span> <span class="o">*</span> <span class="nx">b</span><span class="p">.</span><span class="nx">m31</span>
        <span class="nx">a</span><span class="p">.</span><span class="nx">m11</span> <span class="o">*</span> <span class="nx">b</span><span class="p">.</span><span class="nx">m12</span> <span class="o">+</span> <span class="nx">a</span><span class="p">.</span><span class="nx">m12</span> <span class="o">*</span> <span class="nx">b</span><span class="p">.</span><span class="nx">m22</span> <span class="o">+</span> <span class="nx">a</span><span class="p">.</span><span class="nx">m13</span> <span class="o">*</span> <span class="nx">b</span><span class="p">.</span><span class="nx">m32</span>
        <span class="nx">a</span><span class="p">.</span><span class="nx">m11</span> <span class="o">*</span> <span class="nx">b</span><span class="p">.</span><span class="nx">m13</span> <span class="o">+</span> <span class="nx">a</span><span class="p">.</span><span class="nx">m12</span> <span class="o">*</span> <span class="nx">b</span><span class="p">.</span><span class="nx">m23</span> <span class="o">+</span> <span class="nx">a</span><span class="p">.</span><span class="nx">m13</span> <span class="o">*</span> <span class="nx">b</span><span class="p">.</span><span class="nx">m33</span>
        <span class="nx">a</span><span class="p">.</span><span class="nx">m21</span> <span class="o">*</span> <span class="nx">b</span><span class="p">.</span><span class="nx">m11</span> <span class="o">+</span> <span class="nx">a</span><span class="p">.</span><span class="nx">m22</span> <span class="o">*</span> <span class="nx">b</span><span class="p">.</span><span class="nx">m21</span> <span class="o">+</span> <span class="nx">a</span><span class="p">.</span><span class="nx">m23</span> <span class="o">*</span> <span class="nx">b</span><span class="p">.</span><span class="nx">m31</span>
        <span class="nx">a</span><span class="p">.</span><span class="nx">m21</span> <span class="o">*</span> <span class="nx">b</span><span class="p">.</span><span class="nx">m12</span> <span class="o">+</span> <span class="nx">a</span><span class="p">.</span><span class="nx">m22</span> <span class="o">*</span> <span class="nx">b</span><span class="p">.</span><span class="nx">m22</span> <span class="o">+</span> <span class="nx">a</span><span class="p">.</span><span class="nx">m23</span> <span class="o">*</span> <span class="nx">b</span><span class="p">.</span><span class="nx">m32</span>
        <span class="nx">a</span><span class="p">.</span><span class="nx">m21</span> <span class="o">*</span> <span class="nx">b</span><span class="p">.</span><span class="nx">m13</span> <span class="o">+</span> <span class="nx">a</span><span class="p">.</span><span class="nx">m22</span> <span class="o">*</span> <span class="nx">b</span><span class="p">.</span><span class="nx">m23</span> <span class="o">+</span> <span class="nx">a</span><span class="p">.</span><span class="nx">m23</span> <span class="o">*</span> <span class="nx">b</span><span class="p">.</span><span class="nx">m33</span>
        <span class="nx">a</span><span class="p">.</span><span class="nx">m31</span> <span class="o">*</span> <span class="nx">b</span><span class="p">.</span><span class="nx">m11</span> <span class="o">+</span> <span class="nx">a</span><span class="p">.</span><span class="nx">m32</span> <span class="o">*</span> <span class="nx">b</span><span class="p">.</span><span class="nx">m21</span> <span class="o">+</span> <span class="nx">a</span><span class="p">.</span><span class="nx">m33</span> <span class="o">*</span> <span class="nx">b</span><span class="p">.</span><span class="nx">m31</span>
        <span class="nx">a</span><span class="p">.</span><span class="nx">m31</span> <span class="o">*</span> <span class="nx">b</span><span class="p">.</span><span class="nx">m12</span> <span class="o">+</span> <span class="nx">a</span><span class="p">.</span><span class="nx">m32</span> <span class="o">*</span> <span class="nx">b</span><span class="p">.</span><span class="nx">m22</span> <span class="o">+</span> <span class="nx">a</span><span class="p">.</span><span class="nx">m33</span> <span class="o">*</span> <span class="nx">b</span><span class="p">.</span><span class="nx">m32</span>
        <span class="nx">a</span><span class="p">.</span><span class="nx">m31</span> <span class="o">*</span> <span class="nx">b</span><span class="p">.</span><span class="nx">m13</span> <span class="o">+</span> <span class="nx">a</span><span class="p">.</span><span class="nx">m32</span> <span class="o">*</span> <span class="nx">b</span><span class="p">.</span><span class="nx">m23</span> <span class="o">+</span> <span class="nx">a</span><span class="p">.</span><span class="nx">m33</span> <span class="o">*</span> <span class="nx">b</span><span class="p">.</span><span class="nx">m33</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Compute the translation portion</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">a</span><span class="p">.</span><span class="nx">tx</span> <span class="o">*</span> <span class="nx">b</span><span class="p">.</span><span class="nx">m11</span> <span class="o">+</span> <span class="nx">a</span><span class="p">.</span><span class="nx">ty</span> <span class="o">*</span> <span class="nx">b</span><span class="p">.</span><span class="nx">m21</span> <span class="o">+</span> <span class="nx">a</span><span class="p">.</span><span class="nx">tz</span> <span class="o">*</span> <span class="nx">b</span><span class="p">.</span><span class="nx">m31</span> <span class="o">+</span> <span class="nx">b</span><span class="p">.</span><span class="nx">tx</span>
        <span class="nx">a</span><span class="p">.</span><span class="nx">tx</span> <span class="o">*</span> <span class="nx">b</span><span class="p">.</span><span class="nx">m12</span> <span class="o">+</span> <span class="nx">a</span><span class="p">.</span><span class="nx">ty</span> <span class="o">*</span> <span class="nx">b</span><span class="p">.</span><span class="nx">m22</span> <span class="o">+</span> <span class="nx">a</span><span class="p">.</span><span class="nx">tz</span> <span class="o">*</span> <span class="nx">b</span><span class="p">.</span><span class="nx">m32</span> <span class="o">+</span> <span class="nx">b</span><span class="p">.</span><span class="nx">ty</span>
        <span class="nx">a</span><span class="p">.</span><span class="nx">tx</span> <span class="o">*</span> <span class="nx">b</span><span class="p">.</span><span class="nx">m13</span> <span class="o">+</span> <span class="nx">a</span><span class="p">.</span><span class="nx">ty</span> <span class="o">*</span> <span class="nx">b</span><span class="p">.</span><span class="nx">m23</span> <span class="o">+</span> <span class="nx">a</span><span class="p">.</span><span class="nx">tz</span> <span class="o">*</span> <span class="nx">b</span><span class="p">.</span><span class="nx">m33</span> <span class="o">+</span> <span class="nx">b</span><span class="p">.</span><span class="nx">tz</span>
        <span class="p">)</span>
    <span class="k">else</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span> <span class="s2">&quot;&#39;a&#39; must be specified an instance of Vector or Matrix.&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <h2>determinant(m:<em>Matrix</em>):<em>Number</em></h2>

<p>[static]
Compute the determinant of the 3x3 portion of the matrix.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">@determinant</span><span class="o">:</span><span class="nf">(m)-&gt;</span>
    <span class="nx">m</span><span class="p">.</span><span class="nx">m11</span> <span class="o">*</span> <span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">m22</span> <span class="o">*</span> <span class="nx">m</span><span class="p">.</span><span class="nx">m33</span> <span class="o">-</span> <span class="nx">m</span><span class="p">.</span><span class="nx">m23</span> <span class="o">*</span> <span class="nx">m</span><span class="p">.</span><span class="nx">m32</span><span class="p">)</span> <span class="o">+</span>
    <span class="nx">m</span><span class="p">.</span><span class="nx">m12</span> <span class="o">*</span> <span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">m23</span> <span class="o">*</span> <span class="nx">m</span><span class="p">.</span><span class="nx">m31</span> <span class="o">-</span> <span class="nx">m</span><span class="p">.</span><span class="nx">m21</span> <span class="o">*</span> <span class="nx">m</span><span class="p">.</span><span class="nx">m33</span><span class="p">)</span> <span class="o">+</span>
    <span class="nx">m</span><span class="p">.</span><span class="nx">m13</span> <span class="o">*</span> <span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">m21</span> <span class="o">*</span> <span class="nx">m</span><span class="p">.</span><span class="nx">m32</span> <span class="o">-</span> <span class="nx">m</span><span class="p">.</span><span class="nx">m22</span> <span class="o">*</span> <span class="nx">m</span><span class="p">.</span><span class="nx">m31</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <h2>inverse(m:<em>Matrix</em>):<em>Matrix</em></h2>

<p>[static]
Compute the inverse of a matrix.  We use the classical adjoint divided
by the determinant method.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">@invert</span><span class="o">:</span><span class="nf">(m)-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Compute the determinant</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">det = </span><span class="nx">@determinant</span> <span class="nx">m</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>If we're singular, then the determinant is zero and there's
no inverse</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">unless</span> <span class="nx">abs</span><span class="p">(</span><span class="nx">det</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.000001</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span> <span class="s2">&quot;Zero matrix doesn&#39;t have inverse matrix.&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Compute one over the determinant, so we divide once and
can <em>multiply</em> per element</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">oneOverDet = </span><span class="mi">1</span> <span class="o">/</span> <span class="nx">det</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Compute the 3x3 portion of the inverse, by
dividing the adjoint by the determinant</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">new</span> <span class="nx">Matrix</span><span class="p">(</span>
      <span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">m22</span> <span class="o">*</span> <span class="nx">m</span><span class="p">.</span><span class="nx">m33</span> <span class="o">-</span> <span class="nx">m</span><span class="p">.</span><span class="nx">m23</span> <span class="o">*</span> <span class="nx">m</span><span class="p">.</span><span class="nx">m32</span><span class="p">)</span> <span class="o">*</span> <span class="nx">oneOverDet</span>
      <span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">m13</span> <span class="o">*</span> <span class="nx">m</span><span class="p">.</span><span class="nx">m32</span> <span class="o">-</span> <span class="nx">m</span><span class="p">.</span><span class="nx">m12</span> <span class="o">*</span> <span class="nx">m</span><span class="p">.</span><span class="nx">m33</span><span class="p">)</span> <span class="o">*</span> <span class="nx">oneOverDet</span>
      <span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">m12</span> <span class="o">*</span> <span class="nx">m</span><span class="p">.</span><span class="nx">m23</span> <span class="o">-</span> <span class="nx">m</span><span class="p">.</span><span class="nx">m13</span> <span class="o">*</span> <span class="nx">m</span><span class="p">.</span><span class="nx">m22</span><span class="p">)</span> <span class="o">*</span> <span class="nx">oneOverDet</span>

      <span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">m23</span> <span class="o">*</span> <span class="nx">m</span><span class="p">.</span><span class="nx">m31</span> <span class="o">-</span> <span class="nx">m</span><span class="p">.</span><span class="nx">m21</span> <span class="o">*</span> <span class="nx">m</span><span class="p">.</span><span class="nx">m33</span><span class="p">)</span> <span class="o">*</span> <span class="nx">oneOverDet</span>
      <span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">m11</span> <span class="o">*</span> <span class="nx">m</span><span class="p">.</span><span class="nx">m33</span> <span class="o">-</span> <span class="nx">m</span><span class="p">.</span><span class="nx">m13</span> <span class="o">*</span> <span class="nx">m</span><span class="p">.</span><span class="nx">m31</span><span class="p">)</span> <span class="o">*</span> <span class="nx">oneOverDet</span>
      <span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">m13</span> <span class="o">*</span> <span class="nx">m</span><span class="p">.</span><span class="nx">m21</span> <span class="o">-</span> <span class="nx">m</span><span class="p">.</span><span class="nx">m11</span> <span class="o">*</span> <span class="nx">m</span><span class="p">.</span><span class="nx">m23</span><span class="p">)</span> <span class="o">*</span> <span class="nx">oneOverDet</span>

      <span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">m21</span> <span class="o">*</span> <span class="nx">m</span><span class="p">.</span><span class="nx">m32</span> <span class="o">-</span> <span class="nx">m</span><span class="p">.</span><span class="nx">m22</span> <span class="o">*</span> <span class="nx">m</span><span class="p">.</span><span class="nx">m31</span><span class="p">)</span> <span class="o">*</span> <span class="nx">oneOverDet</span>
      <span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">m12</span> <span class="o">*</span> <span class="nx">m</span><span class="p">.</span><span class="nx">m31</span> <span class="o">-</span> <span class="nx">m</span><span class="p">.</span><span class="nx">m11</span> <span class="o">*</span> <span class="nx">m</span><span class="p">.</span><span class="nx">m32</span><span class="p">)</span> <span class="o">*</span> <span class="nx">oneOverDet</span>
      <span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">m11</span> <span class="o">*</span> <span class="nx">m</span><span class="p">.</span><span class="nx">m22</span> <span class="o">-</span> <span class="nx">m</span><span class="p">.</span><span class="nx">m12</span> <span class="o">*</span> <span class="nx">m</span><span class="p">.</span><span class="nx">m21</span><span class="p">)</span> <span class="o">*</span> <span class="nx">oneOverDet</span>

      <span class="o">-</span><span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">tx</span> <span class="o">*</span> <span class="nx">r</span><span class="p">.</span><span class="nx">m11</span> <span class="o">+</span> <span class="nx">m</span><span class="p">.</span><span class="nx">ty</span> <span class="o">*</span> <span class="nx">r</span><span class="p">.</span><span class="nx">m21</span> <span class="o">+</span> <span class="nx">m</span><span class="p">.</span><span class="nx">tz</span> <span class="o">*</span> <span class="nx">r</span><span class="p">.</span><span class="nx">m31</span><span class="p">)</span>
      <span class="o">-</span><span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">tx</span> <span class="o">*</span> <span class="nx">r</span><span class="p">.</span><span class="nx">m12</span> <span class="o">+</span> <span class="nx">m</span><span class="p">.</span><span class="nx">ty</span> <span class="o">*</span> <span class="nx">r</span><span class="p">.</span><span class="nx">m22</span> <span class="o">+</span> <span class="nx">m</span><span class="p">.</span><span class="nx">tz</span> <span class="o">*</span> <span class="nx">r</span><span class="p">.</span><span class="nx">m32</span><span class="p">)</span>
      <span class="o">-</span><span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">tx</span> <span class="o">*</span> <span class="nx">r</span><span class="p">.</span><span class="nx">m13</span> <span class="o">+</span> <span class="nx">m</span><span class="p">.</span><span class="nx">ty</span> <span class="o">*</span> <span class="nx">r</span><span class="p">.</span><span class="nx">m23</span> <span class="o">+</span> <span class="nx">m</span><span class="p">.</span><span class="nx">tz</span> <span class="o">*</span> <span class="nx">r</span><span class="p">.</span><span class="nx">m33</span><span class="p">)</span>
      <span class="p">)</span>

  <span class="nx">constructor</span><span class="o">:</span><span class="nf">(m11, m12, m13, m21, m22, m23, m31, m32, m33, tx, ty, tz)-&gt;</span>
    <span class="nx">unless</span> <span class="err">@</span> <span class="k">instanceof</span> <span class="nx">Matrix</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nx">Matrix</span> <span class="nx">m11</span><span class="p">,</span> <span class="nx">m12</span><span class="p">,</span> <span class="nx">m13</span><span class="p">,</span> <span class="nx">m21</span><span class="p">,</span> <span class="nx">m22</span><span class="p">,</span> <span class="nx">m23</span><span class="p">,</span> <span class="nx">m31</span><span class="p">,</span> <span class="nx">m32</span><span class="p">,</span> <span class="nx">m33</span><span class="p">,</span> <span class="nx">tx</span><span class="p">,</span> <span class="nx">ty</span><span class="p">,</span> <span class="nx">tz</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">m = </span><span class="nx">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">instanceof</span> <span class="nx">Matrix</span>
      <span class="vi">@m11 = </span><span class="nx">m</span><span class="p">.</span><span class="nx">m11</span>
      <span class="vi">@m12 = </span><span class="nx">m</span><span class="p">.</span><span class="nx">m12</span>
      <span class="vi">@m13 = </span><span class="nx">m</span><span class="p">.</span><span class="nx">m13</span>
      <span class="vi">@m21 = </span><span class="nx">m</span><span class="p">.</span><span class="nx">m21</span>
      <span class="vi">@m22 = </span><span class="nx">m</span><span class="p">.</span><span class="nx">m22</span>
      <span class="vi">@m23 = </span><span class="nx">m</span><span class="p">.</span><span class="nx">m23</span>
      <span class="vi">@m31 = </span><span class="nx">m</span><span class="p">.</span><span class="nx">m31</span>
      <span class="vi">@m32 = </span><span class="nx">m</span><span class="p">.</span><span class="nx">m32</span>
      <span class="vi">@m33 = </span><span class="nx">m</span><span class="p">.</span><span class="nx">m33</span>
      <span class="vi">@tx = </span><span class="nx">m</span><span class="p">.</span><span class="nx">tx</span>
      <span class="vi">@ty = </span><span class="nx">m</span><span class="p">.</span><span class="nx">ty</span>
      <span class="vi">@tz = </span><span class="nx">m</span><span class="p">.</span><span class="nx">tz</span>
    <span class="k">else</span>
      <span class="vi">@m11 = </span><span class="nx">m11</span>
      <span class="vi">@m12 = </span><span class="nx">m12</span>
      <span class="vi">@m13 = </span><span class="nx">m13</span>
      <span class="vi">@m21 = </span><span class="nx">m21</span>
      <span class="vi">@m22 = </span><span class="nx">m22</span>
      <span class="vi">@m23 = </span><span class="nx">m23</span>
      <span class="vi">@m31 = </span><span class="nx">m31</span>
      <span class="vi">@m32 = </span><span class="nx">m32</span>
      <span class="vi">@m33 = </span><span class="nx">m33</span>
      <span class="vi">@tx = </span><span class="nx">tx</span>
      <span class="vi">@ty = </span><span class="nx">ty</span>
      <span class="vi">@tz = </span><span class="nx">tz</span>

  <span class="nx">setupView</span><span class="o">:</span><span class="nf">(camera)-&gt;</span>
    <span class="nv">z = </span><span class="nx">Vector</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span><span class="nx">camera</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">position</span><span class="p">,</span> <span class="nx">camera</span><span class="p">.</span><span class="nx">position</span><span class="p">)</span>
    <span class="nx">z</span><span class="p">.</span><span class="nx">normalize</span><span class="p">()</span>
    <span class="nv">x = </span><span class="nx">Vector</span><span class="p">.</span><span class="nx">crossProduct</span><span class="p">(</span><span class="nx">camera</span><span class="p">.</span><span class="nx">up</span><span class="p">,</span> <span class="nx">z</span><span class="p">)</span>
    <span class="nx">x</span><span class="p">.</span><span class="nx">normalize</span><span class="p">()</span>
    <span class="nv">y = </span><span class="nx">Vector</span><span class="p">.</span><span class="nx">crossProduct</span><span class="p">(</span><span class="nx">z</span><span class="p">,</span> <span class="nx">x</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>console.log z, x, y</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@m11 = </span><span class="nx">x</span><span class="p">.</span><span class="nx">x</span>
    <span class="vi">@m12 = </span><span class="nx">y</span><span class="p">.</span><span class="nx">x</span>
    <span class="vi">@m13 = </span><span class="nx">z</span><span class="p">.</span><span class="nx">x</span>
    <span class="vi">@m21 = </span><span class="nx">x</span><span class="p">.</span><span class="nx">y</span>
    <span class="vi">@m22 = </span><span class="nx">y</span><span class="p">.</span><span class="nx">y</span>
    <span class="vi">@m23 = </span><span class="nx">z</span><span class="p">.</span><span class="nx">y</span>
    <span class="vi">@m31 = </span><span class="nx">x</span><span class="p">.</span><span class="nx">z</span>
    <span class="vi">@m32 = </span><span class="nx">y</span><span class="p">.</span><span class="nx">z</span>
    <span class="vi">@m33 = </span><span class="nx">z</span><span class="p">.</span><span class="nx">z</span>
    <span class="vi">@tx = </span><span class="o">-</span><span class="nx">Vector</span><span class="p">.</span><span class="nx">dotProduct</span> <span class="nx">camera</span><span class="p">.</span><span class="nx">position</span><span class="p">,</span> <span class="nx">x</span>
    <span class="vi">@ty = </span><span class="o">-</span><span class="nx">Vector</span><span class="p">.</span><span class="nx">dotProduct</span> <span class="nx">camera</span><span class="p">.</span><span class="nx">position</span><span class="p">,</span> <span class="nx">y</span>
    <span class="vi">@tz = </span><span class="o">-</span><span class="nx">Vector</span><span class="p">.</span><span class="nx">dotProduct</span> <span class="nx">camera</span><span class="p">.</span><span class="nx">position</span><span class="p">,</span> <span class="nx">z</span>
    <span class="k">return</span>

  <span class="nx">setupProjection</span><span class="o">:</span><span class="nf">(camera, screen)-&gt;</span>
    <span class="nv">sy = </span><span class="mi">1</span> <span class="o">/</span> <span class="nx">tan</span><span class="p">(</span><span class="nx">camera</span><span class="p">.</span><span class="nx">fov</span> <span class="err">/ 2)</span>
    <span class="nv">sx = </span><span class="nx">sy</span> <span class="o">*</span> <span class="nx">screen</span><span class="p">.</span><span class="nx">screenHeight</span> <span class="err">/ screen.screenWidth</span>
    <span class="nv">sz = </span><span class="nx">camera</span><span class="p">.</span><span class="nx">far</span> <span class="err">/ (camera.far - camera.near)</span>
    <span class="vi">@m11 = </span><span class="nx">sx</span>
    <span class="vi">@m12 = </span><span class="mi">0</span>
    <span class="vi">@m13 = </span><span class="mi">0</span>
    <span class="vi">@m21 = </span><span class="mi">0</span>
    <span class="vi">@m22 = </span><span class="nx">sy</span>
    <span class="vi">@m23 = </span><span class="mi">0</span>
    <span class="vi">@m31 = </span><span class="mi">0</span>
    <span class="vi">@m32 = </span><span class="mi">0</span>
    <span class="vi">@m33 = </span><span class="nx">sz</span>
    <span class="vi">@tx = </span><span class="mi">0</span>
    <span class="vi">@ty = </span><span class="mi">0</span>
    <span class="vi">@tz = </span><span class="o">-</span><span class="nx">sz</span> <span class="o">*</span> <span class="nx">camera</span><span class="p">.</span><span class="nx">near</span>
    <span class="k">return</span>

  <span class="nx">setupScreen</span><span class="o">:</span><span class="nf">(screen)-&gt;</span>
    <span class="nv">w = </span><span class="nx">screen</span><span class="p">.</span><span class="nx">screenWidth</span> <span class="err">/ 2</span>
    <span class="nv">h = </span><span class="nx">screen</span><span class="p">.</span><span class="nx">screenHeight</span> <span class="err">/ 2</span>
    <span class="vi">@m11 = </span><span class="nx">w</span>
    <span class="vi">@m12 = </span><span class="mi">0</span>
    <span class="vi">@m13 = </span><span class="mi">0</span>
    <span class="vi">@m21 = </span><span class="mi">0</span>
    <span class="vi">@m22 = </span><span class="o">-</span><span class="nx">h</span>
    <span class="vi">@m23 = </span><span class="mi">0</span>
    <span class="vi">@m31 = </span><span class="mi">0</span>
    <span class="vi">@m32 = </span><span class="mi">0</span>
    <span class="vi">@m33 = </span><span class="mi">1</span>
    <span class="vi">@tx = </span><span class="nx">w</span>
    <span class="vi">@ty = </span><span class="nx">h</span>
    <span class="vi">@tz = </span><span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>identity():<em>void</em>
Set the matrix to identity</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">identity</span><span class="o">:-&gt;</span>
    <span class="vi">@m11 = </span><span class="mi">1</span>
    <span class="vi">@m12 = </span><span class="mi">0</span>
    <span class="vi">@m13 = </span><span class="mi">0</span>
    <span class="vi">@m21 = </span><span class="mi">0</span>
    <span class="vi">@m22 = </span><span class="mi">1</span>
    <span class="vi">@m23 = </span><span class="mi">0</span>
    <span class="vi">@m31 = </span><span class="mi">0</span>
    <span class="vi">@m32 = </span><span class="mi">0</span>
    <span class="vi">@m33 = </span><span class="mi">1</span>
    <span class="vi">@tx = </span><span class="mi">0</span>
    <span class="vi">@ty = </span><span class="mi">0</span>
    <span class="vi">@tz = </span><span class="mi">0</span>
    <span class="k">return</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>zeroTranslation():<em>void</em>
Zero the 4th row of the matrix, which contains the translation portion.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">zeroTranslation</span><span class="o">:-&gt;</span>
    <span class="vi">@tx = @ty = @tz = </span><span class="mi">0</span>
    <span class="k">return</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>setTranslation(d:<em>Vector</em>):<em>void</em>
Sets the translation portion of the matrix in vector form</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">setTranslation</span><span class="o">:</span><span class="nf">(d)-&gt;</span>
    <span class="vi">@tx = </span><span class="nx">d</span><span class="p">.</span><span class="nx">x</span>
    <span class="vi">@ty = </span><span class="nx">d</span><span class="p">.</span><span class="nx">y</span>
    <span class="vi">@tz = </span><span class="nx">d</span><span class="p">.</span><span class="nx">z</span>
    <span class="k">return</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>setTranslation(d:<em>Vector</em>):<em>void</em>
Sets the translation portion of the matrix in vector form</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">setupTranslation</span><span class="o">:</span><span class="nf">(d)-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Set the linear transformation portion to identity</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@m11 = </span><span class="mi">1</span>
    <span class="vi">@m12 = </span><span class="mi">0</span>
    <span class="vi">@m13 = </span><span class="mi">0</span>
    <span class="vi">@m21 = </span><span class="mi">0</span>
    <span class="vi">@m22 = </span><span class="mi">1</span>
    <span class="vi">@m23 = </span><span class="mi">0</span>
    <span class="vi">@m31 = </span><span class="mi">0</span>
    <span class="vi">@m32 = </span><span class="mi">0</span>
    <span class="vi">@m33 = </span><span class="mi">1</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Set the translation portion</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@tx = </span><span class="nx">d</span><span class="p">.</span><span class="nx">x</span>
    <span class="vi">@ty = </span><span class="nx">d</span><span class="p">.</span><span class="nx">y</span>
    <span class="vi">@tz = </span><span class="nx">d</span><span class="p">.</span><span class="nx">z</span>
    <span class="k">return</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>setupLocalToParent(pos:<em>Vector</em>, orient:<em>EulerAngles</em>):<em>void</em>
setupLocalToParent(pos:<em>Vector</em>, orient:<em>RotationMatrix</em>):<em>void</em>
Setup the matrix to perform a local -> parent transformation, given
the position and orientation of the local reference frame within the
parent reference frame.
A very common use of this will be to construct a object -> world matrix.
As an example, the transformation in this case is straightforward.  We
first rotate from object space into inertial space, then we translate
into world space.
We allow the orientation to be specified using either euler angles,
or a RotationMatrix</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">setupLocalToParent</span><span class="o">:</span><span class="nf">(pos, orient)-&gt;</span>
    <span class="k">if</span> <span class="nx">orient</span> <span class="k">instanceof</span> <span class="nx">EulerAngles</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Create a rotation matrix.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">orientMatrix = </span><span class="k">new</span> <span class="nx">RotationMatrix</span>
      <span class="nx">orientMatrix</span><span class="p">.</span><span class="nx">setup</span> <span class="nx">orient</span>
      <span class="nv">orient = </span><span class="nx">orientMatrix</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Copy the rotation portion of the matrix.  According to
the comments in RotationMatrix.cpp, the rotation matrix
is "normally" an inertial->object matrix, which is
parent->local.  We want a local->parent rotation, so we
must transpose while copying</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@m11 = </span><span class="nx">orient</span><span class="p">.</span><span class="nx">m11</span>
    <span class="vi">@m12 = </span><span class="nx">orient</span><span class="p">.</span><span class="nx">m21</span>
    <span class="vi">@m13 = </span><span class="nx">orient</span><span class="p">.</span><span class="nx">m31</span>
    <span class="vi">@m21 = </span><span class="nx">orient</span><span class="p">.</span><span class="nx">m12</span>
    <span class="vi">@m22 = </span><span class="nx">orient</span><span class="p">.</span><span class="nx">m22</span>
    <span class="vi">@m23 = </span><span class="nx">orient</span><span class="p">.</span><span class="nx">m32</span>
    <span class="vi">@m31 = </span><span class="nx">orient</span><span class="p">.</span><span class="nx">m13</span>
    <span class="vi">@m32 = </span><span class="nx">orient</span><span class="p">.</span><span class="nx">m23</span>
    <span class="vi">@m33 = </span><span class="nx">orient</span><span class="p">.</span><span class="nx">m33</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Now set the translation portion.  Translation happens "after"
the 3x3 portion, so we can simply copy the position
field directly</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@tx = </span><span class="nx">pos</span><span class="p">.</span><span class="nx">x</span>
    <span class="vi">@ty = </span><span class="nx">pos</span><span class="p">.</span><span class="nx">y</span>
    <span class="vi">@tz = </span><span class="nx">pos</span><span class="p">.</span><span class="nx">z</span>
    <span class="k">return</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>setupParentToLocal(pos:<em>Vector</em>, orient:<em>EulerAngles</em>):<em>void</em>
setupParentToLocal(pos:<em>Vector</em>, orient:<em>RotationMatrix</em>):<em>void</em>
Setup the matrix to perform a parent -> local transformation, given
the position and orientation of the local reference frame within the
parent reference frame.
A very common use of this will be to construct a world -> object matrix.
To perform this transformation, we would normally FIRST transform
from world to inertial space, and then rotate from inertial space into
object space.  However, out 4x3 matrix always translates last.  So
we think about creating two matrices T and R, and then concatonating
M = TR.
We allow the orientation to be specified using either euler angles,
or a RotationMatrix</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">setupParentToLocal</span><span class="o">:</span><span class="nf">(pos, orient)-&gt;</span>
    <span class="k">if</span> <span class="nx">orient</span> <span class="k">instanceof</span> <span class="nx">EulerAngles</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Create a rotation matrix.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">matrix = </span><span class="k">new</span> <span class="nx">RotationMatrix</span>
      <span class="nx">matrix</span><span class="p">.</span><span class="nx">setup</span> <span class="nx">orient</span>
      <span class="nv">orient = </span><span class="nx">matrix</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Copy the rotation portion of the matrix.  We can copy the
elements directly (without transposing) according
to the layout as commented in RotationMatrix.cpp</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@m11 = </span><span class="nx">orient</span><span class="p">.</span><span class="nx">m11</span>
    <span class="vi">@m12 = </span><span class="nx">orient</span><span class="p">.</span><span class="nx">m12</span>
    <span class="vi">@m13 = </span><span class="nx">orient</span><span class="p">.</span><span class="nx">m13</span>
    <span class="vi">@m21 = </span><span class="nx">orient</span><span class="p">.</span><span class="nx">m21</span>
    <span class="vi">@m22 = </span><span class="nx">orient</span><span class="p">.</span><span class="nx">m22</span>
    <span class="vi">@m23 = </span><span class="nx">orient</span><span class="p">.</span><span class="nx">m23</span>
    <span class="vi">@m31 = </span><span class="nx">orient</span><span class="p">.</span><span class="nx">m31</span>
    <span class="vi">@m32 = </span><span class="nx">orient</span><span class="p">.</span><span class="nx">m32</span>
    <span class="vi">@m33 = </span><span class="nx">orient</span><span class="p">.</span><span class="nx">m33</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>Now set the translation portion.  Normally, we would
translate by the negative of the position to translate
from world to inertial space.  However, we must correct
for the fact that the rotation occurs "first."  So we
must rotate the translation portion.  This is the same
as create a translation matrix T to translate by -pos,
and a rotation matrix R, and then creating the matrix
as the concatenation of TR</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@tx = </span><span class="o">-</span><span class="p">(</span><span class="nx">pos</span><span class="p">.</span><span class="nx">x</span> <span class="o">*</span> <span class="nx">@m11</span> <span class="o">+</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">y</span> <span class="o">*</span> <span class="nx">@m21</span> <span class="o">+</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">z</span> <span class="o">*</span> <span class="nx">@m31</span><span class="p">)</span>
    <span class="vi">@ty = </span><span class="o">-</span><span class="p">(</span><span class="nx">pos</span><span class="p">.</span><span class="nx">x</span> <span class="o">*</span> <span class="nx">@m12</span> <span class="o">+</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">y</span> <span class="o">*</span> <span class="nx">@m22</span> <span class="o">+</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">z</span> <span class="o">*</span> <span class="nx">@m32</span><span class="p">)</span>
    <span class="vi">@tz = </span><span class="o">-</span><span class="p">(</span><span class="nx">pos</span><span class="p">.</span><span class="nx">x</span> <span class="o">*</span> <span class="nx">@m13</span> <span class="o">+</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">y</span> <span class="o">*</span> <span class="nx">@m23</span> <span class="o">+</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">z</span> <span class="o">*</span> <span class="nx">@m33</span><span class="p">)</span>
    <span class="k">return</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <h2>setupRotate(axis:<em>int</em>, theta:<em>Number</em>):<em>void</em></h2>

<h2>setupRotate(axis:<em>Vector</em>, theta:<em>Number</em>):<em>void</em></h2>

<p>Setup the matrix to perform a rotation about a cardinal axis
The axis of rotation is specified using a 1-based index:
1 => rotate about the x-axis
2 => rotate about the y-axis
3 => rotate about the z-axis
theta is the amount of rotation, in radians.  The left-hand rule is
used to define "positive" rotation.
The translation portion is reset.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">setupRotate</span><span class="o">:</span><span class="nf">(axis, theta)-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Get sin and cosine of rotation angle</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">s = </span><span class="nx">sin</span> <span class="nx">theta</span>
    <span class="nv">c = </span><span class="nx">cos</span> <span class="nx">theta</span>
    <span class="nx">unless</span> <span class="nx">axis</span> <span class="k">instanceof</span> <span class="nx">Vector</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>Check which axis they are rotating about</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">switch</span> <span class="nx">axis</span>
        <span class="k">when</span> <span class="mi">1</span>  <span class="c1"># Rotate about the x-axis</span>
          <span class="vi">@m11 = </span><span class="mi">1</span>
          <span class="vi">@m12 = </span><span class="mi">0</span>
          <span class="vi">@m13 = </span><span class="mi">0</span>
          <span class="vi">@m21 = </span><span class="mi">0</span>
          <span class="vi">@m22 = </span><span class="nx">c</span>
          <span class="vi">@m23 = </span><span class="nx">s</span>
          <span class="vi">@m31 = </span><span class="mi">0</span>
          <span class="vi">@m32 = </span><span class="o">-</span><span class="nx">s</span>
          <span class="vi">@m33 = </span><span class="nx">c</span>
        <span class="k">when</span> <span class="mi">2</span>  <span class="c1"># Rotate about the y-axis</span>
          <span class="vi">@m11 = </span><span class="nx">c</span>
          <span class="vi">@m12 = </span><span class="mi">0</span>
          <span class="vi">@m13 = </span><span class="o">-</span><span class="nx">s</span>
          <span class="vi">@m21 = </span><span class="mi">0</span>
          <span class="vi">@m22 = </span><span class="mi">1</span>
          <span class="vi">@m23 = </span><span class="mi">0</span>
          <span class="vi">@m31 = </span><span class="nx">s</span>
          <span class="vi">@m32 = </span><span class="mi">0</span>
          <span class="vi">@m33 = </span><span class="nx">c</span>
        <span class="k">when</span> <span class="mi">3</span>  <span class="c1"># Rotate about the z-axis</span>
          <span class="vi">@m11 = </span><span class="nx">c</span>
          <span class="vi">@m12 = </span><span class="nx">s</span>
          <span class="vi">@m13 = </span><span class="mi">0</span>
          <span class="vi">@m21 = </span><span class="o">-</span><span class="nx">s</span>
          <span class="vi">@m22 = </span><span class="nx">c</span>
          <span class="vi">@m23 = </span><span class="mi">0</span>
          <span class="vi">@m31 = </span><span class="mi">0</span>
          <span class="vi">@m32 = </span><span class="mi">0</span>
          <span class="vi">@m33 = </span><span class="mi">1</span>
        <span class="k">else</span>    <span class="c1"># bogus axis index</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s2">&quot;&#39;axis&#39; must be specified 1, 2 or 3.&quot;</span>
    <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>Compute 1 - cos(theta) and some common subexpressions</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">a = </span><span class="mi">1</span> <span class="o">-</span> <span class="nx">c</span>
      <span class="nv">ax = </span><span class="nx">a</span> <span class="o">*</span> <span class="nx">axis</span><span class="p">.</span><span class="nx">x</span>
      <span class="nv">ay = </span><span class="nx">a</span> <span class="o">*</span> <span class="nx">axis</span><span class="p">.</span><span class="nx">y</span>
      <span class="nv">az = </span><span class="nx">a</span> <span class="o">*</span> <span class="nx">axis</span><span class="p">.</span><span class="nx">z</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>Set the matrix elements.  There is still a little more
opportunity for optimization due to the many common
subexpressions.  We'll let the compiler handle that...</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="vi">@m11 = </span><span class="nx">ax</span> <span class="o">*</span> <span class="nx">axis</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">c</span>
      <span class="vi">@m12 = </span><span class="nx">ax</span> <span class="o">*</span> <span class="nx">axis</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="nx">axis</span><span class="p">.</span><span class="nx">z</span> <span class="o">*</span> <span class="nx">s</span>
      <span class="vi">@m13 = </span><span class="nx">ax</span> <span class="o">*</span> <span class="nx">axis</span><span class="p">.</span><span class="nx">z</span> <span class="o">-</span> <span class="nx">axis</span><span class="p">.</span><span class="nx">y</span> <span class="o">*</span> <span class="nx">s</span>
      <span class="vi">@m21 = </span><span class="nx">ay</span> <span class="o">*</span> <span class="nx">axis</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">axis</span><span class="p">.</span><span class="nx">z</span> <span class="o">*</span> <span class="nx">s</span>
      <span class="vi">@m22 = </span><span class="nx">ay</span> <span class="o">*</span> <span class="nx">axis</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="nx">c</span>
      <span class="vi">@m23 = </span><span class="nx">ay</span> <span class="o">*</span> <span class="nx">axis</span><span class="p">.</span><span class="nx">z</span> <span class="o">+</span> <span class="nx">axis</span><span class="p">.</span><span class="nx">x</span> <span class="o">*</span> <span class="nx">s</span>
      <span class="vi">@m31 = </span><span class="nx">az</span> <span class="o">*</span> <span class="nx">axis</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">axis</span><span class="p">.</span><span class="nx">y</span> <span class="o">*</span> <span class="nx">s</span>
      <span class="vi">@m32 = </span><span class="nx">az</span> <span class="o">*</span> <span class="nx">axis</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="nx">axis</span><span class="p">.</span><span class="nx">x</span> <span class="o">*</span> <span class="nx">s</span>
      <span class="vi">@m33 = </span><span class="nx">az</span> <span class="o">*</span> <span class="nx">axis</span><span class="p">.</span><span class="nx">z</span> <span class="o">+</span> <span class="nx">c</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>Reset the translation portion</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@tx = @ty = @tz = </span><span class="mi">0</span>
    <span class="k">return</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>fromQuaternion(q:<em>Quaternion</em>):<em>void</em>
Setup the matrix to perform a rotation, given the angular displacement
in quaternion form.
The translation portion is reset.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">fromQuaternion</span><span class="o">:</span><span class="nf">(q)-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>Compute a few values to optimize common subexpressions</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">ww = </span><span class="mi">2</span> <span class="o">*</span> <span class="nx">q</span><span class="p">.</span><span class="nx">w</span>
    <span class="nv">xx = </span><span class="mi">2</span> <span class="o">*</span> <span class="nx">q</span><span class="p">.</span><span class="nx">x</span>
    <span class="nv">yy = </span><span class="mi">2</span> <span class="o">*</span> <span class="nx">q</span><span class="p">.</span><span class="nx">y</span>
    <span class="nv">zz = </span><span class="mi">2</span> <span class="o">*</span> <span class="nx">q</span><span class="p">.</span><span class="nx">z</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>Set the matrix elements.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">wwx = </span><span class="nx">ww</span> <span class="o">*</span> <span class="nx">q</span><span class="p">.</span><span class="nx">x</span>
    <span class="nv">wwy = </span><span class="nx">ww</span> <span class="o">*</span> <span class="nx">q</span><span class="p">.</span><span class="nx">y</span>
    <span class="nv">wwz = </span><span class="nx">ww</span> <span class="o">*</span> <span class="nx">q</span><span class="p">.</span><span class="nx">z</span>
    <span class="nv">xxx = </span><span class="nx">xx</span> <span class="o">*</span> <span class="nx">q</span><span class="p">.</span><span class="nx">x</span>
    <span class="nv">xxy = </span><span class="nx">xx</span> <span class="o">*</span> <span class="nx">q</span><span class="p">.</span><span class="nx">y</span>
    <span class="nv">xxz = </span><span class="nx">xx</span> <span class="o">*</span> <span class="nx">q</span><span class="p">.</span><span class="nx">z</span>
    <span class="nv">yyy = </span><span class="nx">yy</span> <span class="o">*</span> <span class="nx">q</span><span class="p">.</span><span class="nx">y</span>
    <span class="nv">yyz = </span><span class="nx">yy</span> <span class="o">*</span> <span class="nx">q</span><span class="p">.</span><span class="nx">z</span>
    <span class="nv">zzz = </span><span class="nx">yy</span> <span class="o">*</span> <span class="nx">q</span><span class="p">.</span><span class="nx">z</span>
    <span class="vi">@m11 = </span><span class="mi">1</span> <span class="o">-</span> <span class="nx">yyy</span> <span class="o">-</span> <span class="nx">zzz</span>
    <span class="vi">@m12 = </span><span class="nx">xxy</span> <span class="o">+</span> <span class="nx">wwz</span>
    <span class="vi">@m13 = </span><span class="nx">xxz</span> <span class="o">-</span> <span class="nx">wwy</span>
    <span class="vi">@m21 = </span><span class="nx">xxy</span> <span class="o">-</span> <span class="nx">wwz</span>
    <span class="vi">@m22 = </span><span class="mi">1</span> <span class="o">-</span> <span class="nx">xxx</span> <span class="o">-</span> <span class="nx">zzz</span>
    <span class="vi">@m23 = </span><span class="nx">yyz</span> <span class="o">+</span> <span class="nx">wwx</span>
    <span class="vi">@m31 = </span><span class="nx">xxz</span> <span class="o">+</span> <span class="nx">wwy</span>
    <span class="vi">@m32 = </span><span class="nx">yyz</span> <span class="o">-</span> <span class="nx">wwx</span>
    <span class="vi">@m33 = </span><span class="mi">1</span> <span class="o">-</span> <span class="nx">xxx</span> <span class="o">-</span> <span class="nx">yyy</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>Reset the translation portion</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@tx = @ty = @tz = </span><span class="mi">0</span>
    <span class="k">return</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>setupScale(v:Number):<em>void</em>
Setup the matrix to perform scale on each axis.  For uniform scale by k,
use a vector of the form Vector(k,k,k)
The translation portion is reset.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">setupScale</span><span class="o">:</span><span class="nf">(v)-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>Set the matrix elements.  Pretty straightforward</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@m11 = </span><span class="nx">s</span><span class="p">.</span><span class="nx">x</span>
    <span class="vi">@m12 = </span><span class="mi">0</span>
    <span class="vi">@m13 = </span><span class="mi">0</span>
    <span class="vi">@m21 = </span><span class="mi">0</span>
    <span class="vi">@m22 = </span><span class="nx">s</span><span class="p">.</span><span class="nx">y</span>
    <span class="vi">@m23 = </span><span class="mi">0</span>
    <span class="vi">@m31 = </span><span class="mi">0</span>
    <span class="vi">@m32 = </span><span class="mi">0</span>
    <span class="vi">@m33 = </span><span class="nx">s</span><span class="p">.</span><span class="nx">z</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>Reset the translation portion</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@tx = @ty = @tz = </span><span class="mi">0</span>
    <span class="k">return</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <h2>setupScaleAlongAxis(axis:<em>int</em>, x:<em>Number</em>):<em>void</em></h2>

<p>Setup the matrix to perform scale along an arbitrary axis.
The axis is specified using a unit vector.
The translation portion is reset.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">setupScaleAlongAxis</span><span class="o">:</span><span class="nf">(axis, x)-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>Quick sanity check to make sure they passed in a unit vector
to specify the axis</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">unless</span> <span class="nx">abs</span><span class="p">(</span><span class="nx">Vector</span><span class="p">.</span><span class="nx">magnitudeSquared</span><span class="p">(</span><span class="nx">axis</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.01</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span> <span class="s2">&quot;&#39;axis&#39; must be specified a unit vector.&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>Compute k-1 and some common subexpressions</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">a = </span><span class="nx">k</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="nv">ax = </span><span class="nx">a</span> <span class="o">*</span> <span class="nx">axis</span><span class="p">.</span><span class="nx">x</span>
    <span class="nv">ay = </span><span class="nx">a</span> <span class="o">*</span> <span class="nx">axis</span><span class="p">.</span><span class="nx">y</span>
    <span class="nv">az = </span><span class="nx">a</span> <span class="o">*</span> <span class="nx">axis</span><span class="p">.</span><span class="nx">z</span></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>Fill in the matrix elements.  We'll do the common
subexpression optimization ourselves here, since diagonally
opposite matrix elements are equal</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@m11 = </span><span class="nx">ax</span> <span class="o">*</span> <span class="nx">axis</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="vi">@m22 = </span><span class="nx">ay</span> <span class="o">*</span> <span class="nx">axis</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="vi">@m33 = </span><span class="nx">az</span> <span class="o">*</span> <span class="nx">axis</span><span class="p">.</span><span class="nx">z</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="vi">@m21 = @m21 = </span><span class="nx">ax</span> <span class="o">*</span> <span class="nx">axis</span><span class="p">.</span><span class="nx">y</span>
    <span class="vi">@m13 = @m31 = </span><span class="nx">ax</span> <span class="o">*</span> <span class="nx">axis</span><span class="p">.</span><span class="nx">z</span>
    <span class="vi">@m23 = @m32 = </span><span class="nx">ay</span> <span class="o">*</span> <span class="nx">axis</span><span class="p">.</span><span class="nx">z</span></pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>Reset the translation portion</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@tx = @ty = @tz = </span><span class="mi">0</span>
    <span class="k">return</span></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>setupShear(axis:<em>int</em>, s:<em>Number</em>, t:<em>Number</em>):<em>void</em>
Setup the matrix to perform a shear
The type of shear is specified by the 1-based "axis" index.  The effect
of transforming a point by the matrix is described by the pseudocode
below:
axis == 1  =>  y += s<em>x, z += t</em>x
axis == 2  =>  x += s<em>y, z += t</em>y
axis == 3  =>  x += s<em>z, y += t</em>z
The translation portion is reset.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">setupShear</span><span class="o">:</span><span class="nf">(axis, s, t)-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>Check which type of shear they want</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">switch</span> <span class="nx">axis</span>
      <span class="k">when</span> <span class="mi">1</span>  <span class="c1"># Shear y and z using x</span>
        <span class="vi">@m11 = </span><span class="mi">1</span>
        <span class="vi">@m12 = </span><span class="nx">s</span>
        <span class="vi">@m13 = </span><span class="nx">t</span>
        <span class="vi">@m21 = </span><span class="mi">0</span>
        <span class="vi">@m22 = </span><span class="mi">1</span>
        <span class="vi">@m23 = </span><span class="mi">0</span>
        <span class="vi">@m31 = </span><span class="mi">0</span>
        <span class="vi">@m32 = </span><span class="mi">0</span>
        <span class="vi">@m33 = </span><span class="mi">1</span>
      <span class="k">when</span> <span class="mi">2</span>  <span class="c1"># Shear x and z using y</span>
        <span class="vi">@m11 = </span><span class="mi">1</span>
        <span class="vi">@m12 = </span><span class="mi">0</span>
        <span class="vi">@m13 = </span><span class="mi">0</span>
        <span class="vi">@m21 = </span><span class="nx">s</span>
        <span class="vi">@m22 = </span><span class="mi">1</span>
        <span class="vi">@m23 = </span><span class="nx">t</span>
        <span class="vi">@m31 = </span><span class="mi">0</span>
        <span class="vi">@m32 = </span><span class="mi">0</span>
        <span class="vi">@m33 = </span><span class="mi">1</span>
      <span class="k">when</span> <span class="mi">3</span>  <span class="c1"># Shear x and y using z</span>
        <span class="vi">@m11 = </span><span class="mi">1</span>
        <span class="vi">@m12 = </span><span class="mi">0</span>
        <span class="vi">@m13 = </span><span class="mi">0</span>
        <span class="vi">@m21 = </span><span class="mi">0</span>
        <span class="vi">@m22 = </span><span class="mi">1</span>
        <span class="vi">@m23 = </span><span class="mi">0</span>
        <span class="vi">@m31 = </span><span class="nx">s</span>
        <span class="vi">@m32 = </span><span class="nx">t</span>
        <span class="vi">@m33 = </span><span class="mi">1</span>
      <span class="k">else</span>    <span class="c1"># bogus axis index</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span> <span class="s2">&quot;axis must be specified 1, 2 or 3.&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p>Reset the translation portion</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@tx = @ty = @tz = </span><span class="mi">0</span>
    <span class="k">return</span></pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <p>setupProject(n:<em>Number</em>):<em>void</em>
Setup the matrix to perform a projection onto a plane passing
through the origin.  The plane is perpendicular to the
unit vector n.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">setupProject</span><span class="o">:</span><span class="nf">(n)-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p>Quick sanity check to make sure they passed in a unit vector
to specify the axis</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">unless</span> <span class="nx">abs</span><span class="p">(</span><span class="nx">Vector</span><span class="p">.</span><span class="nx">magnitudeSquared</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.1</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span> <span class="s2">&quot;&#39;n&#39; must be specified a unit vector.&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <p>Fill in the matrix elements.  We'll do the common
subexpression optimization ourselves here, since diagonally
opposite matrix elements are equal</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@m11 = </span><span class="mi">1</span> <span class="o">-</span> <span class="nx">n</span><span class="p">.</span><span class="nx">x</span> <span class="o">*</span> <span class="nx">n</span><span class="p">.</span><span class="nx">x</span>
    <span class="vi">@m22 = </span><span class="mi">1</span> <span class="o">-</span> <span class="nx">n</span><span class="p">.</span><span class="nx">y</span> <span class="o">*</span> <span class="nx">n</span><span class="p">.</span><span class="nx">y</span>
    <span class="vi">@m33 = </span><span class="mi">1</span> <span class="o">-</span> <span class="nx">n</span><span class="p">.</span><span class="nx">z</span> <span class="o">*</span> <span class="nx">n</span><span class="p">.</span><span class="nx">z</span>
    <span class="vi">@m12 = @m21 = </span><span class="o">-</span><span class="nx">n</span><span class="p">.</span><span class="nx">x</span> <span class="o">*</span> <span class="nx">n</span><span class="p">.</span><span class="nx">y</span>
    <span class="vi">@m13 = @m31 = </span><span class="o">-</span><span class="nx">n</span><span class="p">.</span><span class="nx">x</span> <span class="o">*</span> <span class="nx">n</span><span class="p">.</span><span class="nx">z</span>
    <span class="vi">@m23 = @m32 = </span><span class="o">-</span><span class="nx">n</span><span class="p">.</span><span class="nx">y</span> <span class="o">*</span> <span class="nx">n</span><span class="p">.</span><span class="nx">z</span></pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <p>Reset the translation portion</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@tx = @ty = @tz = </span><span class="mi">0</span>
    <span class="k">return</span></pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <h2>setupReflect(axis:<em>int</em>, k:<em>Number</em> = 0):<em>void</em></h2>

<p>Setup the matrix to perform a reflection about a plane parallel
to a cardinal plane.
axis is a 1-based index which specifies the plane to project about:
1 => reflect about the plane x=k
2 => reflect about the plane y=k
3 => reflect about the plane z=k
The translation is set appropriately, since translation must occur if
k != 0</p>

<h2>setupReflect(axis:<em>Vector</em>, k:<em>Number</em> = 0):<em>void</em></h2>

<p>Setup the matrix to perform a reflection about an arbitrary plane
through the origin.  The unit vector n is perpendicular to the plane.
The translation portion is reset.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">setupReflect</span><span class="o">:</span><span class="nf">(axis, k = 0)-&gt;</span>
    <span class="nx">unless</span> <span class="nx">axis</span> <span class="k">instanceof</span> <span class="nx">Vector</span></pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <p>Check which plane they want to reflect about</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">switch</span> <span class="nx">axis</span>
        <span class="k">when</span> <span class="mi">1</span>  <span class="c1"># Reflect about the plane x=k</span>
          <span class="vi">@m11 = </span><span class="o">-</span><span class="mi">1</span>
          <span class="vi">@m12 = </span><span class="mi">0</span>
          <span class="vi">@m13 = </span><span class="mi">0</span>
          <span class="vi">@m21 = </span><span class="mi">0</span>
          <span class="vi">@m22 = </span><span class="mi">1</span>
          <span class="vi">@m23 = </span><span class="mi">0</span>
          <span class="vi">@m31 = </span><span class="mi">0</span>
          <span class="vi">@m32 = </span><span class="mi">0</span>
          <span class="vi">@m33 = </span><span class="mi">1</span>
          <span class="vi">@tx = </span><span class="mi">2</span> <span class="o">*</span> <span class="nx">k</span>
          <span class="vi">@ty = </span><span class="mi">0</span>
          <span class="vi">@tz = </span><span class="mi">0</span>
        <span class="k">when</span> <span class="mi">2</span>  <span class="c1"># Reflect about the plane y=k</span>
          <span class="vi">@m11 = </span><span class="mi">1</span>
          <span class="vi">@m12 = </span><span class="mi">0</span>
          <span class="vi">@m13 = </span><span class="mi">0</span>
          <span class="vi">@m21 = </span><span class="mi">0</span>
          <span class="vi">@m22 = </span><span class="o">-</span><span class="mi">1</span>
          <span class="vi">@m23 = </span><span class="mi">0</span>
          <span class="vi">@m31 = </span><span class="mi">0</span>
          <span class="vi">@m32 = </span><span class="mi">0</span>
          <span class="vi">@m33 = </span><span class="mi">1</span>
          <span class="vi">@tx = </span><span class="mi">0</span>
          <span class="vi">@ty = </span><span class="mi">2</span> <span class="o">*</span> <span class="nx">k</span>
          <span class="vi">@tz = </span><span class="mi">0</span>
        <span class="k">when</span> <span class="mi">2</span>  <span class="c1"># Reflect about the plane z=k</span>
          <span class="vi">@m11 = </span><span class="mi">1</span>
          <span class="vi">@m12 = </span><span class="mi">0</span>
          <span class="vi">@m13 = </span><span class="mi">0</span>
          <span class="vi">@m21 = </span><span class="mi">0</span>
          <span class="vi">@m22 = </span><span class="mi">1</span>
          <span class="vi">@m23 = </span><span class="mi">0</span>
          <span class="vi">@m31 = </span><span class="mi">0</span>
          <span class="vi">@m32 = </span><span class="mi">0</span>
          <span class="vi">@m33 = </span><span class="o">-</span><span class="mi">1</span>
          <span class="vi">@tx = </span><span class="mi">0</span>
          <span class="vi">@ty = </span><span class="mi">0</span>
          <span class="vi">@tz = </span><span class="mi">2</span> <span class="o">*</span> <span class="nx">k</span>
        <span class="k">else</span>    <span class="c1"># bogus axis index</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span> <span class="s2">&quot;&#39;axis&#39; must be specified 1, 2 or 3.&quot;</span>
    <span class="k">else</span>
      <span class="nv">n = </span><span class="nx">axis</span></pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <p>Quick sanity check to make sure they passed in a unit vector
to specify the axis</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">unless</span> <span class="nx">abss</span><span class="p">(</span><span class="nx">Vector</span><span class="p">.</span><span class="nx">magnitudeSquared</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.01</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span> <span class="s2">&quot;&#39;n&#39; must be specified a unit vector.&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <p>Compute common subexpressions</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">ax = </span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="nx">n</span><span class="p">.</span><span class="nx">x</span>
      <span class="nv">ay = </span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="nx">n</span><span class="p">.</span><span class="nx">y</span>
      <span class="nv">az = </span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="nx">n</span><span class="p">.</span><span class="nx">z</span></pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <p>Fill in the matrix elements.  We'll do the common
subexpression optimization ourselves here, since diagonally
opposite matrix elements are equal</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="vi">@m11 = </span><span class="mi">1</span> <span class="o">+</span> <span class="nx">ax</span> <span class="o">*</span> <span class="nx">n</span><span class="p">.</span><span class="nx">x</span>
      <span class="vi">@m22 = </span><span class="mi">1</span> <span class="o">+</span> <span class="nx">ay</span> <span class="o">*</span> <span class="nx">n</span><span class="p">.</span><span class="nx">y</span>
      <span class="vi">@m33 = </span><span class="mi">1</span> <span class="o">+</span> <span class="nx">az</span> <span class="o">*</span> <span class="nx">n</span><span class="p">.</span><span class="nx">z</span>
      <span class="vi">@m12 = @m21 = </span><span class="nx">ax</span> <span class="o">*</span> <span class="nx">n</span><span class="p">.</span><span class="nx">y</span>
      <span class="vi">@m13 = @m31 = </span><span class="nx">ax</span> <span class="o">*</span> <span class="nx">n</span><span class="p">.</span><span class="nx">z</span>
      <span class="vi">@m23 = @m32 = </span><span class="nx">ay</span> <span class="o">*</span> <span class="nx">n</span><span class="p">.</span><span class="nx">z</span></pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <p>Reset the translation portion</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="vi">@tx = @ty = @tz = </span><span class="mi">0</span>
    <span class="k">return</span></pre></div>             </td>           </tr>                               <tr id="section-61">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-61">&#182;</a>               </div>               <h2>getTranslation(m:<em>Matrix</em>):<em>Vector</em></h2>

<p>Return the translation row of the matrix in vector form</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">getTranslation</span><span class="o">:</span><span class="nf">(m)-&gt;</span>
    <span class="k">new</span> <span class="nx">Vector</span> <span class="nx">m</span><span class="p">.</span><span class="nx">tx</span><span class="p">,</span> <span class="nx">m</span><span class="p">.</span><span class="nx">ty</span><span class="p">,</span> <span class="nx">m</span><span class="p">.</span><span class="nx">tz</span></pre></div>             </td>           </tr>                               <tr id="section-62">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-62">&#182;</a>               </div>               <h2>getPositionFromParentToLocalMatrix(m:<em>Matrix</em>):<em>Vector</em></h2>

<p>matrix (such as a world -> object matrix)
We assume that the matrix represents a rigid transformation.  (No scale,
skew, or mirroring)</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">getPositionFromParentToLocalMatrix</span><span class="o">:</span><span class="nf">(m)-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-63">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-63">&#182;</a>               </div>               <p>Multiply negative translation value by the
transpose of the 3x3 portion.  By using the transpose,
we assume that the matrix is orthogonal.  (This function
doesn't really make sense for non-rigid transformations...)</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">new</span> <span class="nx">Vector</span><span class="p">(</span>
      <span class="o">-</span><span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">tx</span> <span class="o">*</span> <span class="nx">m</span><span class="p">.</span><span class="nx">m11</span> <span class="o">+</span> <span class="nx">m</span><span class="p">.</span><span class="nx">ty</span> <span class="o">*</span> <span class="nx">m</span><span class="p">.</span><span class="nx">m12</span> <span class="o">+</span> <span class="nx">m</span><span class="p">.</span><span class="nx">tz</span> <span class="o">*</span> <span class="nx">m</span><span class="p">.</span><span class="nx">m13</span><span class="p">)</span>
      <span class="o">-</span><span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">tx</span> <span class="o">*</span> <span class="nx">m</span><span class="p">.</span><span class="nx">m21</span> <span class="o">+</span> <span class="nx">m</span><span class="p">.</span><span class="nx">ty</span> <span class="o">*</span> <span class="nx">m</span><span class="p">.</span><span class="nx">m22</span> <span class="o">+</span> <span class="nx">m</span><span class="p">.</span><span class="nx">tz</span> <span class="o">*</span> <span class="nx">m</span><span class="p">.</span><span class="nx">m23</span><span class="p">)</span>
      <span class="o">-</span><span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">tx</span> <span class="o">*</span> <span class="nx">m</span><span class="p">.</span><span class="nx">m31</span> <span class="o">+</span> <span class="nx">m</span><span class="p">.</span><span class="nx">ty</span> <span class="o">*</span> <span class="nx">m</span><span class="p">.</span><span class="nx">m32</span> <span class="o">+</span> <span class="nx">m</span><span class="p">.</span><span class="nx">tz</span> <span class="o">*</span> <span class="nx">m</span><span class="p">.</span><span class="nx">m33</span><span class="p">)</span>
      <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-64">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-64">&#182;</a>               </div>               <h2>getPositionFromLocalToParentMatrix(m:<em>Matrix</em>):<em>Vector</em></h2>

<p>Extract the position of an object given a local -> parent transformation
matrix (such as an object -> world matrix)</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">getPositionFromLocalToParentMatrix</span><span class="o">:</span><span class="nf">(m)-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-65">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-65">&#182;</a>               </div>               <p>Position is simply the translation portion</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">new</span> <span class="nx">Vector</span> <span class="nx">m</span><span class="p">.</span><span class="nx">tx</span><span class="p">,</span> <span class="nx">m</span><span class="p">.</span><span class="nx">ty</span><span class="p">,</span> <span class="nx">m</span><span class="p">.</span><span class="nx">tz</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 